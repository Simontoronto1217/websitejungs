<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AntiGravity — Command Center</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GSAP (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            ink: { 950: '#070812', 900: '#0a0b16', 800: '#0f1020' }
          },
          boxShadow: {
            luxe: '0 40px 120px rgba(0,0,0,.55)',
            glass: '0 12px 48px rgba(0,0,0,.35)'
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --bg0:#05060a;
      --bg1:#070812;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --gold: #c9a86a;
      --ice: #9bdcff;
      --danger: #ff6b6b;
      --warn: #ffcc66;
      --ok: #7CFFB2;
    }

    html, body {
      height: 100%;
      background: radial-gradient(1200px 800px at 30% 25%, rgba(155,220,255,.12), transparent 60%),
                  radial-gradient(900px 700px at 70% 75%, rgba(201,168,106,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow: hidden;
    }

    /* Background canvas container */
    #bg {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    /* Subtle film grain & vignette */
    #fx {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 10;
      background:
        radial-gradient(1200px 900px at 50% 35%, transparent 35%, rgba(0,0,0,.55) 85%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0 1px, transparent 1px 3px);
      mix-blend-mode: overlay;
      opacity: .28;
      filter: blur(.2px);
    }

    /* Glass panel */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--tw-shadow-color, 0 12px 48px rgba(0,0,0,.35));
      backdrop-filter: blur(18px) saturate(140%);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
    }

    /* Premium hairlines */
    .hairline {
      border-color: rgba(255,255,255,.12);
    }

    /* Custom scroll for table */
    .scroll-luxe::-webkit-scrollbar { width: 10px; height: 10px; }
    .scroll-luxe::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.14);
      border: 2px solid rgba(0,0,0,.0);
      background-clip: padding-box;
      border-radius: 10px;
    }
    .scroll-luxe::-webkit-scrollbar-track { background: rgba(255,255,255,.03); border-radius: 10px; }

    /* Inputs */
    .field {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
    }
    .field:focus {
      border-color: rgba(155,220,255,.38);
      background: rgba(255,255,255,.06);
      transform: translateY(-1px);
    }

    /* Buttons */
    .btn {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 10px 14px;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    .btn:hover { transform: translateY(-1px); background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.20); }
    .btn:active { transform: translateY(0px) scale(.99); }

    .btn-primary {
      border-color: rgba(155,220,255,.28);
      background: linear-gradient(180deg, rgba(155,220,255,.18), rgba(155,220,255,.08));
    }
    .btn-gold {
      border-color: rgba(201,168,106,.28);
      background: linear-gradient(180deg, rgba(201,168,106,.16), rgba(201,168,106,.06));
    }

    /* Dial widget */
    .dial {
      position: relative;
      width: 120px; height: 120px;
      border-radius: 999px;
      background: radial-gradient(circle at 40% 35%, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      overflow: hidden;
    }
    .dial::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 210deg, rgba(201,168,106,.0), rgba(201,168,106,.18), rgba(155,220,255,.12), rgba(201,168,106,.0));
      filter: blur(12px);
      opacity: .8;
      animation: dialGlow 9s linear infinite;
    }
    @keyframes dialGlow { to { transform: rotate(360deg); } }

    .engraving {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px; height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(201,168,106,.22);
      color: rgba(201,168,106,.95);
      background: rgba(201,168,106,.08);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      cursor: default;
      user-select: none;
    }

    /* Sisyphus stage */
    #sisyphusStage{
      position: fixed;
      left: 24px;
      bottom: 22px;
      width: 420px;
      height: 220px;
      pointer-events: none;
      z-index: 20;
      opacity: 0;
      transform: translateY(14px);
      filter: drop-shadow(0 18px 50px rgba(0,0,0,.55));
    }
    #sisyphusHill {
      position:absolute; inset: 0;
      background:
        linear-gradient(140deg, rgba(255,255,255,.00) 30%, rgba(255,255,255,.06) 35%, rgba(255,255,255,.00) 55%),
        linear-gradient(160deg, rgba(0,0,0,.0) 30%, rgba(0,0,0,.22) 70%),
        radial-gradient(800px 300px at 20% 140%, rgba(201,168,106,.14), transparent 55%);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    #sisyphusFigure {
      position: absolute;
      left: 40px;
      bottom: 46px;
      width: 120px;
      opacity: .96;
    }
    #sisyphusRock {
      position: absolute;
      left: 160px;
      bottom: 58px;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 2px 10px rgba(0,0,0,.35);
    }
    #sisyphusPlaque {
      position:absolute;
      right: 18px;
      top: 18px;
      width: 210px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(14px);
      opacity: 0;
      transform: translateY(6px);
    }
    #sisyphusPlaque .title{
      font-size: 12px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,.72);
    }
    #sisyphusPlaque .count{
      font-size: 30px;
      font-weight: 700;
      line-height: 1.05;
      margin-top: 6px;
    }
    #sisyphusPlaque .list{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.68);
      display: grid;
      gap: 4px;
    }

    /* Connection badge */
    .badge {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot { width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.45); }
    .dot.ok { background: rgba(124,255,178,.75); }
    .dot.warn { background: rgba(255,204,102,.8); }
  </style>
</head>

<body>
  <!-- Three.js background -->
  <div id="bg" aria-hidden="true"></div>
  <div id="fx" aria-hidden="true"></div>

  <!-- Main UI -->
  <main class="relative z-10 h-full w-full">
    <section class="h-full w-full flex items-center justify-center p-6">
      <div id="panel" class="glass shadow-glass w-full max-w-6xl rounded-3xl overflow-hidden">
        <!-- Header -->
        <header class="px-6 py-5 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div class="flex items-start gap-4">
            <div class="dial shrink-0"></div>
            <div>
              <div class="text-xs tracking-[.24em] uppercase text-white/60">AntiGravity</div>
              <h1 class="text-2xl md:text-3xl font-semibold leading-tight">
                Command Center <span class="text-white/50 font-normal">— Intervention Dashboard</span>
              </h1>
              <p class="text-sm text-white/60 mt-1 max-w-xl">
                Kollaboration via JSON-Bin: kein Backend-Pathos, nur konsequente Persistenz. 3D ist Atmosphäre, nicht Ablenkung.
              </p>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2 md:justify-end">
            <span id="connBadge" class="badge">
              <span class="dot warn" id="connDot"></span>
              <span id="connText">Local simulation</span>
            </span>
            <button id="btnConfig" class="btn">Config</button>
            <button id="btnSync" class="btn btn-primary">Sync</button>
            <button id="btnSave" class="btn btn-gold">Save</button>
          </div>
        </header>

        <!-- KPIs -->
        <section class="px-6 pb-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="glass rounded-2xl p-4 hairline">
              <div class="text-xs tracking-[.22em] uppercase text-white/55">Open Tickets</div>
              <div class="mt-2 flex items-end gap-3">
                <div id="kpiOpen" class="text-4xl font-semibold">—</div>
                <div class="text-sm text-white/55 pb-1">gesamt</div>
              </div>
              <div id="kpiOpenHint" class="text-xs text-white/45 mt-2">…</div>
            </div>

            <div class="glass rounded-2xl p-4 hairline">
              <div class="text-xs tracking-[.22em] uppercase text-white/55">Priorities</div>
              <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
                <div class="rounded-xl bg-white/5 border border-white/10 p-3">
                  <div class="text-white/50 text-xs">P1</div>
                  <div id="kpiP1" class="text-xl font-semibold mt-1">—</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-3">
                  <div class="text-white/50 text-xs">P2</div>
                  <div id="kpiP2" class="text-xl font-semibold mt-1">—</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/10 p-3">
                  <div class="text-white/50 text-xs">P3</div>
                  <div id="kpiP3" class="text-xl font-semibold mt-1">—</div>
                </div>
              </div>
              <div class="text-xs text-white/45 mt-2">Easter Egg: jede 3. erledigte P3-Eskalation.</div>
            </div>

            <div class="glass rounded-2xl p-4 hairline">
              <div class="text-xs tracking-[.22em] uppercase text-white/55">Health</div>
              <div class="mt-2 flex items-center justify-between">
                <div>
                  <div class="text-sm text-white/55">Last sync</div>
                  <div id="kpiLastSync" class="text-lg font-semibold mt-1">—</div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-white/55">Mode</div>
                  <div id="kpiMode" class="text-lg font-semibold mt-1">—</div>
                </div>
              </div>
              <div class="text-xs text-white/45 mt-2">Optimistisch, aber nicht naiv: Konflikte werden sichtbar, nicht „magisch“ gelöst.</div>
            </div>

            <div class="glass rounded-2xl p-4 hairline">
              <div class="text-xs tracking-[.22em] uppercase text-white/55">Quick Actions</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="btnAdd" class="btn btn-primary">Add Entry</button>
                <button id="btnSeed" class="btn">Seed Demo</button>
                <button id="btnUploadSisy" class="btn">Sisyphus Image</button>
              </div>
              <div class="text-xs text-white/45 mt-2">Tipp: <span class="text-white/60">Cmd/Ctrl + K</span> öffnet Quick Add.</div>
            </div>
          </div>
        </section>

        <!-- Table -->
        <section class="px-6 pb-6">
          <div class="glass rounded-2xl hairline overflow-hidden">
            <div class="px-4 py-3 flex items-center justify-between">
              <div class="text-xs tracking-[.22em] uppercase text-white/55">Entries</div>
              <div class="text-xs text-white/45" id="statusLine">…</div>
            </div>

            <div class="max-h-[420px] overflow-auto scroll-luxe">
              <table class="w-full text-sm">
                <thead class="sticky top-0 z-10 bg-black/25 backdrop-blur-md">
                  <tr class="text-white/55">
                    <th class="text-left font-medium px-4 py-3">Title</th>
                    <th class="text-left font-medium px-4 py-3">Category</th>
                    <th class="text-left font-medium px-4 py-3">Priority</th>
                    <th class="text-left font-medium px-4 py-3">Owner</th>
                    <th class="text-left font-medium px-4 py-3">Status</th>
                    <th class="text-left font-medium px-4 py-3">Updated</th>
                    <th class="text-right font-medium px-4 py-3 w-[90px]">—</th>
                  </tr>
                </thead>
                <tbody id="entryRows" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- Sisyphus Easter Egg Stage -->
  <div id="sisyphusStage" aria-hidden="true">
    <div id="sisyphusHill"></div>
    <img id="sisyphusFigure" alt="Sisyphus" />
    <div id="sisyphusRock"></div>
    <div id="sisyphusPlaque">
      <div class="title">OPEN TICKETS</div>
      <div class="count" id="sisyCount">—</div>
      <div class="list" id="sisyList"></div>
    </div>
  </div>

  <!-- Hidden file input for Sisyphus image -->
  <input id="fileSisy" type="file" accept="image/*" class="hidden" />

  <!-- Config Modal -->
  <div id="modal" class="fixed inset-0 z-30 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-6">
      <div class="glass shadow-luxe w-full max-w-xl rounded-3xl p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs tracking-[.24em] uppercase text-white/55">Persistence</div>
            <h2 class="text-xl font-semibold mt-1">JSON-Bin Configuration</h2>
            <p class="text-sm text-white/55 mt-1">
              Placeholder ist erlaubt. Ohne Key wird lokal simuliert (LocalStorage + Console).
            </p>
          </div>
          <button id="btnCloseModal" class="btn">Close</button>
        </div>

        <div class="mt-4 grid gap-3">
          <label class="grid gap-2">
            <span class="text-xs text-white/55 tracking-[.20em] uppercase">BIN URL (v3)</span>
            <input id="cfgBinUrl" class="field w-full" placeholder="https://api.jsonbin.io/v3/b/YOUR_BIN_ID" />
          </label>

          <label class="grid gap-2">
            <span class="text-xs text-white/55 tracking-[.20em] uppercase">X-Master-Key (optional)</span>
            <input id="cfgMasterKey" class="field w-full" placeholder="YOUR_MASTER_KEY" />
          </label>

          <label class="grid gap-2">
            <span class="text-xs text-white/55 tracking-[.20em] uppercase">X-Access-Key (optional)</span>
            <input id="cfgAccessKey" class="field w-full" placeholder="YOUR_ACCESS_KEY" />
          </label>

          <div class="flex flex-wrap gap-2 mt-2">
            <button id="btnApplyCfg" class="btn btn-primary">Apply</button>
            <button id="btnClearCfg" class="btn">Reset</button>
          </div>

          <div class="text-xs text-white/45 mt-2">
            Hinweis: JSON-Bin v3 liefert typischerweise <code class="text-white/60">{"record": ...}</code>.
            Diese App schreibt/liest direkt den Record.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Add (Cmd/Ctrl+K) -->
  <div id="quick" class="fixed inset-0 z-30 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-6">
      <div class="glass shadow-luxe w-full max-w-2xl rounded-3xl p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xs tracking-[.24em] uppercase text-white/55">Quick Add</div>
            <h2 class="text-xl font-semibold mt-1">New Entry</h2>
          </div>
          <button id="btnCloseQuick" class="btn">Close</button>
        </div>

        <div class="mt-4 grid gap-3">
          <label class="grid gap-2">
            <span class="text-xs text-white/55 tracking-[.20em] uppercase">Title</span>
            <input id="qaTitle" class="field w-full" placeholder="z.B. Auszahlung prüfen / DHL Abholung / Rückruf …" />
          </label>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <label class="grid gap-2">
              <span class="text-xs text-white/55 tracking-[.20em] uppercase">Category</span>
              <select id="qaCategory" class="field w-full">
                <option>Payment</option>
                <option>Logistics</option>
                <option>Customer</option>
                <option>Sales</option>
                <option>Ops</option>
                <option>Agent</option>
              </select>
            </label>

            <label class="grid gap-2">
              <span class="text-xs text-white/55 tracking-[.20em] uppercase">Priority</span>
              <select id="qaPriority" class="field w-full">
                <option>P1</option>
                <option selected>P2</option>
                <option>P3</option>
              </select>
            </label>

            <label class="grid gap-2">
              <span class="text-xs text-white/55 tracking-[.20em] uppercase">Owner</span>
              <input id="qaOwner" class="field w-full" placeholder="Initials / Team" />
            </label>
          </div>

          <div class="flex gap-2 mt-2">
            <button id="btnCreateQuick" class="btn btn-primary">Create</button>
            <button id="btnCreateQuickAndSave" class="btn btn-gold">Create + Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { RoomEnvironment } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/environments/RoomEnvironment.js';

    /**
     * AntiGravity — single-file, "vibecode" Command Center
     * - Three.js glass scene as background atmosphere
     * - Tailwind glass panel overlay
     * - GSAP micro-interactions
     * - JSON-Bin persistence (GET/PUT), fallback local simulation
     */

    // -------------------------
    // Persistence Configuration
    // -------------------------
    const STORAGE_KEY = 'antigravity_state_v1';
    const CFG_KEY = 'antigravity_cfg_v1';

    const DEFAULT_CFG = {
      BIN_URL: 'https://api.jsonbin.io/v3/b/YOUR_BIN_ID',
      X_MASTER_KEY: 'YOUR_MASTER_KEY',
      X_ACCESS_KEY: 'YOUR_ACCESS_KEY'
    };

    const cfg = loadCfg();

    function loadCfg(){
      try {
        const raw = localStorage.getItem(CFG_KEY);
        return raw ? { ...DEFAULT_CFG, ...JSON.parse(raw) } : { ...DEFAULT_CFG };
      } catch {
        return { ...DEFAULT_CFG };
      }
    }

    function saveCfg(next){
      localStorage.setItem(CFG_KEY, JSON.stringify(next));
    }

    function hasRealCloudConfig(){
      const u = (cfg.BIN_URL || '').trim();
      const hasBin = u.startsWith('https://api.jsonbin.io/v3/b/') && !u.includes('YOUR_BIN_ID');
      const hasKey = !String(cfg.X_MASTER_KEY || '').includes('YOUR_MASTER_KEY') && String(cfg.X_MASTER_KEY || '').trim().length > 10;
      const hasAccess = !String(cfg.X_ACCESS_KEY || '').includes('YOUR_ACCESS_KEY') && String(cfg.X_ACCESS_KEY || '').trim().length > 10;
      return { hasBin, hasKey, hasAccess, isReady: hasBin && (hasKey || hasAccess) };
    }

    async function jsonBinFetch({ pathSuffix = '', method = 'GET', body = null }){
      const url = (cfg.BIN_URL || '').trim() + pathSuffix;
      const headers = { 'Content-Type': 'application/json' };

      if (cfg.X_MASTER_KEY && !cfg.X_MASTER_KEY.includes('YOUR_MASTER_KEY')) headers['X-Master-Key'] = cfg.X_MASTER_KEY.trim();
      if (cfg.X_ACCESS_KEY && !cfg.X_ACCESS_KEY.includes('YOUR_ACCESS_KEY')) headers['X-Access-Key'] = cfg.X_ACCESS_KEY.trim();

      const init = { method, headers };
      if (body !== null) init.body = JSON.stringify(body);

      const res = await fetch(url, init);
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`JSON-Bin ${method} failed (${res.status}): ${text.slice(0, 220)}`);
      }
      return res.json();
    }

    async function loadData(){
      const cloud = hasRealCloudConfig();
      setStatus(`Loading… (${cloud.isReady ? 'cloud' : 'local'})`);

      if (!cloud.isReady) {
        // local simulation
        const local = loadLocalState();
        setStatus('Loaded (local simulation).');
        return local;
      }

      try {
        // v3: GET /latest
        const payload = await jsonBinFetch({ pathSuffix: '/latest', method: 'GET' });
        const record = payload?.record;
        if (!record) throw new Error('No record in JSON-Bin response.');
        setStatus('Loaded (cloud).');
        return record;
      } catch (err) {
        console.warn('[AntiGravity] loadData() cloud failed; falling back:', err);
        const local = loadLocalState();
        setStatus('Cloud load failed → local fallback.');
        return local;
      }
    }

    async function saveData(state){
      const cloud = hasRealCloudConfig();
      setStatus(`Saving… (${cloud.isReady ? 'cloud' : 'local'})`);

      // always keep local shadow copy (fast, resilient)
      saveLocalState(state);

      if (!cloud.isReady) {
        console.log('[AntiGravity] Simulated PUT →', cfg.BIN_URL, state);
        setStatus('Saved (local simulation).');
        return { simulated: true };
      }

      try {
        // v3: PUT /b/:id  (write record)
        const payload = await jsonBinFetch({ method: 'PUT', body: state });
        setStatus('Saved (cloud).');
        return payload;
      } catch (err) {
        console.warn('[AntiGravity] saveData() cloud failed; local copy preserved:', err);
        setStatus('Cloud save failed → local preserved.');
        return { error: String(err) };
      }
    }

    function loadLocalState(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        return JSON.parse(raw);
      } catch {
        return defaultState();
      }
    }

    function saveLocalState(state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // -------------------------
    // State Model
    // -------------------------
    function uid(){
      return 'e_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
    }
    function nowIso(){
      return new Date().toISOString();
    }

    const DEFAULT_SISYPHUS_DATA_URL = (() => {
      // Minimal, stylized Sisyphus silhouette (inline SVG -> data URL)
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="240" height="160" viewBox="0 0 240 160">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="rgba(255,255,255,.92)"/>
              <stop offset="1" stop-color="rgba(201,168,106,.92)"/>
            </linearGradient>
            <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="rgba(0,0,0,.55)"/>
            </filter>
          </defs>
          <g filter="url(#s)" opacity=".95" fill="url(#g)">
            <!-- hill hint -->
            <path d="M10 140 C 70 120, 140 110, 230 70 L230 160 L10 160 Z" opacity=".18"/>
            <!-- body -->
            <circle cx="82" cy="74" r="12"/>
            <path d="M78 88 C 66 102, 58 120, 52 138 C 50 144, 60 148, 64 142 C 74 128, 84 112, 96 104 C 112 93, 124 92, 138 90 C 144 89, 144 80, 138 80 C 120 80, 104 82, 92 92 Z" />
            <!-- arm pushing -->
            <path d="M92 98 C 104 90, 118 84, 134 78 C 140 76, 144 84, 138 88 C 124 96, 110 104, 98 112 C 94 114, 88 102, 92 98 Z"/>
            <!-- rock -->
            <circle cx="170" cy="78" r="20" opacity=".90"/>
          </g>
        </svg>
      `.trim();
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    })();

    function defaultState(){
      return {
        meta: {
          version: 1,
          createdAt: nowIso(),
          updatedAt: nowIso(),
          lastSyncAt: null,
          mode: 'AntiGravity'
        },
        counters: {
          completedP3: 0
        },
        assets: {
          sisyphusDataUrl: DEFAULT_SISYPHUS_DATA_URL
        },
        entries: [
          {
            id: uid(),
            title: 'Auszahlung prüfen: Kunde wartet auf Rückmeldung',
            category: 'Payment',
            priority: 'P2',
            owner: 'Ops',
            status: 'Open',
            updatedAt: nowIso()
          },
          {
            id: uid(),
            title: 'DHL Abholung / Logistik-Update: Uhr unterwegs',
            category: 'Logistics',
            priority: 'P3',
            owner: 'Logistics',
            status: 'Open',
            updatedAt: nowIso()
          },
          {
            id: uid(),
            title: 'Kommission/Preis: Klärung mit Sales erforderlich',
            category: 'Sales',
            priority: 'P1',
            owner: 'Sales',
            status: 'Open',
            updatedAt: nowIso()
          }
        ]
      };
    }

    let state = loadLocalState();

    // -------------------------
    // DOM Elements
    // -------------------------
    const el = {
      panel: document.getElementById('panel'),
      rows: document.getElementById('entryRows'),
      statusLine: document.getElementById('statusLine'),

      connDot: document.getElementById('connDot'),
      connText: document.getElementById('connText'),

      kpiOpen: document.getElementById('kpiOpen'),
      kpiOpenHint: document.getElementById('kpiOpenHint'),
      kpiP1: document.getElementById('kpiP1'),
      kpiP2: document.getElementById('kpiP2'),
      kpiP3: document.getElementById('kpiP3'),
      kpiLastSync: document.getElementById('kpiLastSync'),
      kpiMode: document.getElementById('kpiMode'),

      btnAdd: document.getElementById('btnAdd'),
      btnSeed: document.getElementById('btnSeed'),
      btnSync: document.getElementById('btnSync'),
      btnSave: document.getElementById('btnSave'),
      btnConfig: document.getElementById('btnConfig'),
      btnUploadSisy: document.getElementById('btnUploadSisy'),

      modal: document.getElementById('modal'),
      btnCloseModal: document.getElementById('btnCloseModal'),
      cfgBinUrl: document.getElementById('cfgBinUrl'),
      cfgMasterKey: document.getElementById('cfgMasterKey'),
      cfgAccessKey: document.getElementById('cfgAccessKey'),
      btnApplyCfg: document.getElementById('btnApplyCfg'),
      btnClearCfg: document.getElementById('btnClearCfg'),

      quick: document.getElementById('quick'),
      btnCloseQuick: document.getElementById('btnCloseQuick'),
      qaTitle: document.getElementById('qaTitle'),
      qaCategory: document.getElementById('qaCategory'),
      qaPriority: document.getElementById('qaPriority'),
      qaOwner: document.getElementById('qaOwner'),
      btnCreateQuick: document.getElementById('btnCreateQuick'),
      btnCreateQuickAndSave: document.getElementById('btnCreateQuickAndSave'),

      // Sisyphus
      sisyStage: document.getElementById('sisyphusStage'),
      sisyImg: document.getElementById('sisyphusFigure'),
      sisyRock: document.getElementById('sisyphusRock'),
      sisyPlaque: document.getElementById('sisyphusPlaque'),
      sisyCount: document.getElementById('sisyCount'),
      sisyList: document.getElementById('sisyList'),

      fileSisy: document.getElementById('fileSisy')
    };

    // -------------------------
    // Rendering
    // -------------------------
    function fmtTime(iso){
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
      } catch {
        return '—';
      }
    }

    function setStatus(text){
      el.statusLine.textContent = text;
    }

    function updateConnBadge(){
      const cloud = hasRealCloudConfig();
      if (cloud.isReady) {
        el.connDot.className = 'dot ok';
        el.connText.textContent = 'Cloud (JSON-Bin)';
      } else if (cloud.hasBin) {
        el.connDot.className = 'dot warn';
        el.connText.textContent = 'Bin set, key missing (simulation)';
      } else {
        el.connDot.className = 'dot warn';
        el.connText.textContent = 'Local simulation';
      }
    }

    function computeKPIs(){
      const entries = state.entries || [];
      const open = entries.filter(e => e.status !== 'Done').length;
      const p1 = entries.filter(e => e.priority === 'P1' && e.status !== 'Done').length;
      const p2 = entries.filter(e => e.priority === 'P2' && e.status !== 'Done').length;
      const p3 = entries.filter(e => e.priority === 'P3' && e.status !== 'Done').length;
      return { open, p1, p2, p3 };
    }

    function renderKPIs(){
      const { open, p1, p2, p3 } = computeKPIs();
      el.kpiOpen.textContent = String(open);
      el.kpiP1.textContent = String(p1);
      el.kpiP2.textContent = String(p2);
      el.kpiP3.textContent = String(p3);

      const last = state.meta?.lastSyncAt ? fmtTime(state.meta.lastSyncAt) : '—';
      el.kpiLastSync.textContent = last;
      el.kpiMode.textContent = hasRealCloudConfig().isReady ? 'Cloud' : 'Local';

      const tension = (p1 * 3 + p2 * 2 + p3 * 1);
      const hint = tension === 0
        ? 'Calm surface. No submerged fires.'
        : tension >= 8
          ? 'High torque. Priorities are grinding.'
          : 'Moderate load. Keep the cadence.';
      el.kpiOpenHint.textContent = hint;
    }

    function p3OrdinalMap(){
      // Map: entryId -> ordinal among P3 entries by updatedAt (stable-ish)
      const p3 = [...state.entries]
        .filter(e => e.priority === 'P3')
        .sort((a,b) => String(a.updatedAt).localeCompare(String(b.updatedAt)));
      const map = new Map();
      p3.forEach((e, i) => map.set(e.id, i + 1));
      return map;
    }

    function renderRows(){
      const entries = state.entries || [];
      const p3Map = p3OrdinalMap();

      el.rows.innerHTML = entries
        .slice()
        .sort((a,b) => String(b.updatedAt).localeCompare(String(a.updatedAt)))
        .map(e => {
          const ord = p3Map.get(e.id) || 0;
          const hasEngraving = e.priority === 'P3' && ord % 3 === 0;

          const prColor =
            e.priority === 'P1' ? 'text-red-200' :
            e.priority === 'P2' ? 'text-amber-200' :
            'text-emerald-200';

          const stChip =
            e.status === 'Done'
              ? 'bg-emerald-500/15 border-emerald-400/20 text-emerald-100'
              : e.status === 'Blocked'
                ? 'bg-red-500/15 border-red-400/20 text-red-100'
                : 'bg-white/5 border-white/10 text-white/75';

          return `
            <tr data-id="${e.id}" class="hover:bg-white/3 transition-colors">
              <td class="px-4 py-3 align-top">
                <input class="field w-full" data-field="title" value="${escapeHtml(e.title)}" />
              </td>
              <td class="px-4 py-3 align-top">
                <select class="field w-full" data-field="category">
                  ${['Payment','Logistics','Customer','Sales','Ops','Agent'].map(c => `
                    <option ${c===e.category?'selected':''}>${c}</option>
                  `).join('')}
                </select>
              </td>
              <td class="px-4 py-3 align-top">
                <select class="field w-full ${prColor}" data-field="priority">
                  ${['P1','P2','P3'].map(p => `<option ${p===e.priority?'selected':''}>${p}</option>`).join('')}
                </select>
              </td>
              <td class="px-4 py-3 align-top">
                <input class="field w-full" data-field="owner" value="${escapeHtml(e.owner || '')}" placeholder="Team" />
              </td>
              <td class="px-4 py-3 align-top">
                <select class="field w-full border ${stChip}" data-field="status">
                  ${['Open','In Progress','Blocked','Done'].map(s => `<option ${s===e.status?'selected':''}>${s}</option>`).join('')}
                </select>
              </td>
              <td class="px-4 py-3 align-top text-white/55 whitespace-nowrap">${fmtTime(e.updatedAt)}</td>
              <td class="px-4 py-3 align-top text-right">
                <div class="flex items-center justify-end gap-2">
                  ${hasEngraving ? `<span class="engraving" title="engraved cadence">∴</span>` : ''}
                  <button class="btn px-3 py-2 text-xs" data-action="delete">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function renderAll(){
      updateConnBadge();
      renderKPIs();
      renderRows();
      el.sisyImg.src = state.assets?.sisyphusDataUrl || DEFAULT_SISYPHUS_DATA_URL;
    }

    // -------------------------
    // Editing / Events
    // -------------------------
    function touchEntry(id, patch){
      const idx = state.entries.findIndex(e => e.id === id);
      if (idx < 0) return;

      const prev = state.entries[idx];
      const next = { ...prev, ...patch, updatedAt: nowIso() };
      state.entries[idx] = next;
      state.meta.updatedAt = nowIso();
    }

    function addEntry(partial = {}){
      const entry = {
        id: uid(),
        title: partial.title || 'New Entry',
        category: partial.category || 'Ops',
        priority: partial.priority || 'P2',
        owner: partial.owner || '',
        status: partial.status || 'Open',
        updatedAt: nowIso()
      };
      state.entries.unshift(entry);
      state.meta.updatedAt = nowIso();
      renderAll();

      // micro: animate row in
      const row = el.rows.querySelector(`tr[data-id="${entry.id}"]`);
      if (row) gsap.fromTo(row, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: .45, ease: 'power3.out' });
    }

    function deleteEntry(id){
      state.entries = state.entries.filter(e => e.id !== id);
      state.meta.updatedAt = nowIso();
      renderAll();
    }

    function seedDemo(){
      state = defaultState();
      state.entries.unshift(
        { id: uid(), title: 'Rückruf: Kunde erwartet Update (Tonlage deeskalieren)', category: 'Customer', priority: 'P3', owner: 'CS', status: 'Open', updatedAt: nowIso() },
        { id: uid(), title: 'Agent: Status-Update an Stakeholder (präzise, nicht lang)', category: 'Agent', priority: 'P2', owner: 'Lead', status: 'In Progress', updatedAt: nowIso() },
        { id: uid(), title: 'Payment: Auszahlung blockiert → Ursache & ETA klären', category: 'Payment', priority: 'P1', owner: 'Finance', status: 'Blocked', updatedAt: nowIso() }
      );
      state.meta.updatedAt = nowIso();
      renderAll();
      setStatus('Seeded demo dataset.');
    }

    // Delegate table input changes
    el.rows.addEventListener('input', (ev) => {
      const tr = ev.target.closest('tr[data-id]');
      if (!tr) return;
      const id = tr.getAttribute('data-id');
      const field = ev.target.getAttribute('data-field');
      if (!field) return;

      const patch = { [field]: ev.target.value };

      // detect P3 completion cadence for Sisyphus trigger
      if (field === 'status') {
        const prev = state.entries.find(e => e.id === id);
        const wasDone = prev?.status === 'Done';
        const willDone = ev.target.value === 'Done';

        touchEntry(id, patch);
        renderKPIs(); // quick update

        if (!wasDone && willDone && prev?.priority === 'P3') {
          state.counters.completedP3 = (state.counters.completedP3 || 0) + 1;
          const c = state.counters.completedP3;
          if (c % 3 === 0) {
            triggerSisyphus();
          }
        }

        // keep rows fresh (updatedAt)
        renderRows();
        return;
      }

      touchEntry(id, patch);
      renderKPIs();
    });

    el.rows.addEventListener('change', (ev) => {
      // ensure select changes also touch updatedAt (redundant safety)
      const tr = ev.target.closest('tr[data-id]');
      if (!tr) return;
      const id = tr.getAttribute('data-id');
      const field = ev.target.getAttribute('data-field');
      if (!field) return;
      touchEntry(id, { [field]: ev.target.value });
      renderAll();
    });

    el.rows.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-action]');
      if (!btn) return;
      const tr = ev.target.closest('tr[data-id]');
      if (!tr) return;
      const id = tr.getAttribute('data-id');
      const action = btn.getAttribute('data-action');

      if (action === 'delete') {
        gsap.to(tr, { opacity: 0, y: -6, duration: .22, ease: 'power2.in', onComplete: () => deleteEntry(id) });
      }
    });

    // Engraving hover micro-interaction (subtle "nudge")
    el.rows.addEventListener('mouseover', (ev) => {
      const engr = ev.target.closest('.engraving');
      if (!engr) return;
      gsap.fromTo(engr, { rotate: -2, y: 0 }, { rotate: 2, y: -1, duration: .26, yoyo: true, repeat: 1, ease: 'power2.inOut' });
      // tiny hint of rock movement without full stage
      gsap.fromTo(el.sisyRock, { x: 0 }, { x: 6, duration: .22, yoyo: true, repeat: 1, ease: 'power2.inOut' });
    });

    // Buttons
    el.btnAdd.addEventListener('click', () => addEntry());
    el.btnSeed.addEventListener('click', () => seedDemo());

    el.btnSync.addEventListener('click', async () => {
      const loaded = await loadData();
      state = sanitizeState(loaded);
      state.meta.lastSyncAt = nowIso();
      renderAll();
      gsap.fromTo(el.panel, { y: 6, opacity: .92 }, { y: 0, opacity: 1, duration: .5, ease: 'power3.out' });
    });

    el.btnSave.addEventListener('click', async () => {
      state.meta.updatedAt = nowIso();
      const res = await saveData(state);
      state.meta.lastSyncAt = nowIso();
      renderAll();
      if (res?.simulated) {
        gsap.fromTo(el.btnSave, { boxShadow: '0 0 0 rgba(0,0,0,0)' }, { boxShadow: '0 0 0 8px rgba(201,168,106,.14)', duration: .35, yoyo: true, repeat: 1 });
      } else {
        gsap.fromTo(el.btnSave, { boxShadow: '0 0 0 rgba(0,0,0,0)' }, { boxShadow: '0 0 0 10px rgba(155,220,255,.14)', duration: .35, yoyo: true, repeat: 1 });
      }
    });

    // Modal config
    el.btnConfig.addEventListener('click', () => openModal());
    el.btnCloseModal.addEventListener('click', () => closeModal());
    el.btnApplyCfg.addEventListener('click', () => {
      cfg.BIN_URL = el.cfgBinUrl.value.trim();
      cfg.X_MASTER_KEY = el.cfgMasterKey.value.trim();
      cfg.X_ACCESS_KEY = el.cfgAccessKey.value.trim();
      saveCfg(cfg);
      updateConnBadge();
      closeModal();
      setStatus('Config applied.');
    });
    el.btnClearCfg.addEventListener('click', () => {
      Object.assign(cfg, DEFAULT_CFG);
      saveCfg(cfg);
      openModal(true);
      updateConnBadge();
      setStatus('Config reset to defaults.');
    });

    function openModal(prefillOnly = false){
      el.modal.classList.remove('hidden');
      el.cfgBinUrl.value = cfg.BIN_URL || '';
      el.cfgMasterKey.value = cfg.X_MASTER_KEY || '';
      el.cfgAccessKey.value = cfg.X_ACCESS_KEY || '';
      if (!prefillOnly) gsap.fromTo(el.modal.querySelector('.glass'), { y: 14, opacity: 0 }, { y: 0, opacity: 1, duration: .32, ease: 'power3.out' });
    }
    function closeModal(){
      el.modal.classList.add('hidden');
    }

    // Quick Add
    window.addEventListener('keydown', (ev) => {
      const isK = (ev.key || '').toLowerCase() === 'k';
      const mod = ev.metaKey || ev.ctrlKey;
      if (mod && isK) {
        ev.preventDefault();
        openQuick();
      }
      if (ev.key === 'Escape') {
        closeQuick();
        closeModal();
      }
    });

    el.btnCloseQuick.addEventListener('click', () => closeQuick());
    el.btnCreateQuick.addEventListener('click', () => {
      const entry = quickEntryFromForm();
      addEntry(entry);
      closeQuick();
    });
    el.btnCreateQuickAndSave.addEventListener('click', async () => {
      const entry = quickEntryFromForm();
      addEntry(entry);
      closeQuick();
      await saveData(state);
      state.meta.lastSyncAt = nowIso();
      renderAll();
    });

    function openQuick(){
      el.quick.classList.remove('hidden');
      el.qaTitle.value = '';
      el.qaOwner.value = '';
      gsap.fromTo(el.quick.querySelector('.glass'), { y: 16, opacity: 0 }, { y: 0, opacity: 1, duration: .32, ease: 'power3.out' });
      setTimeout(() => el.qaTitle.focus(), 60);
    }
    function closeQuick(){
      el.quick.classList.add('hidden');
    }
    function quickEntryFromForm(){
      return {
        title: el.qaTitle.value.trim() || 'New Entry',
        category: el.qaCategory.value,
        priority: el.qaPriority.value,
        owner: el.qaOwner.value.trim(),
        status: 'Open'
      };
    }

    // Sisyphus image upload
    el.btnUploadSisy.addEventListener('click', () => el.fileSisy.click());
    el.fileSisy.addEventListener('change', async (ev) => {
      const file = ev.target.files?.[0];
      if (!file) return;
      const dataUrl = await readAsDataURL(file);
      state.assets.sisyphusDataUrl = dataUrl;
      state.meta.updatedAt = nowIso();
      renderAll();
      setStatus('Sisyphus image updated (stored in-state).');
    });

    function readAsDataURL(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result));
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function sanitizeState(s){
      // minimal guardrails
      const base = defaultState();
      if (!s || typeof s !== 'object') return base;
      return {
        meta: { ...base.meta, ...(s.meta || {}) },
        counters: { ...base.counters, ...(s.counters || {}) },
        assets: { ...base.assets, ...(s.assets || {}) },
        entries: Array.isArray(s.entries) ? s.entries : base.entries
      };
    }

    // -------------------------
    // Sisyphus Easter Egg
    // -------------------------
    let sisyTl = null;

    function triggerSisyphus(){
      const openEntries = (state.entries || []).filter(e => e.status !== 'Done');
      const openCount = openEntries.length;

      el.sisyCount.textContent = String(openCount);
      el.sisyList.innerHTML = openEntries.slice(0, 3).map(e => `<div>• ${escapeHtml(e.title).slice(0, 42)}${e.title.length>42?'…':''}</div>`).join('');
      if (openEntries.length > 3) el.sisyList.innerHTML += `<div class="text-white/45">… +${openEntries.length - 3} more</div>`;

      if (sisyTl) sisyTl.kill();

      // reset stage
      gsap.set(el.sisyStage, { opacity: 0, y: 14 });
      gsap.set(el.sisyPlaque, { opacity: 0, y: 6 });
      gsap.set(el.sisyImg, { x: 0, y: 0, rotate: 0, scale: 1 });
      gsap.set(el.sisyRock, { x: 0, y: 0, rotate: 0, scale: 1 });

      // "uphill" path (hand-tuned)
      const up = { x: 170, y: -54 };
      const top = { x: 250, y: -92 };

      sisyTl = gsap.timeline({ defaults: { ease: 'power2.inOut' } });
      sisyTl
        .to(el.sisyStage, { opacity: 1, y: 0, duration: .35, ease: 'power3.out' })
        // push sequence
        .to(el.sisyImg, { x: up.x * .55, y: up.y * .55, duration: 1.4 }, 0)
        .to(el.sisyRock, { x: up.x, y: up.y, rotate: 360, duration: 1.4 }, 0)
        .to(el.sisyImg, { x: top.x * .55, y: top.y * .55, duration: 1.15 }, '>-0.15')
        .to(el.sisyRock, { x: top.x, y: top.y, rotate: 720, duration: 1.15 }, '<')
        // plateau plaque
        .to(el.sisyPlaque, { opacity: 1, y: 0, duration: .35, ease: 'power3.out' }, '>-0.05')
        .to({}, { duration: 1.0 }) // let it breathe (watch-brand pacing)
        // roll back (inevitable)
        .to(el.sisyPlaque, { opacity: 0, y: 6, duration: .25 }, '>-0.05')
        .to(el.sisyImg, { x: 0, y: 0, duration: 1.1, ease: 'power2.in' }, '<')
        .to(el.sisyRock, { x: 0, y: 0, rotate: 1080, duration: 1.1, ease: 'power2.in' }, '<')
        .to(el.sisyStage, { opacity: 0, y: 14, duration: .35, ease: 'power3.in' }, '>-0.05');
    }

    // -------------------------
    // Intro Micro-UX
    // -------------------------
    function intro(){
      gsap.fromTo(el.panel, { opacity: 0, y: 16, scale: .992 }, { opacity: 1, y: 0, scale: 1, duration: .85, ease: 'power3.out' });
      gsap.fromTo('.dial', { opacity: 0 }, { opacity: 1, duration: 1.2, ease: 'power2.out' });
    }

    // -------------------------
    // Three.js Background Scene
    // -------------------------
    let renderer, scene, camera, group, clock;
    const mouse = { x: 0, y: 0, tx: 0, ty: 0 };

    function initThree(){
      const container = document.getElementById('bg');

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: 'high-performance' });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.05;
      container.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x05060a, 0.06);

      camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 80);
      camera.position.set(0, 0, 12);

      // Environment (credible specular for glass)
      const pmrem = new THREE.PMREMGenerator(renderer);
      const env = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
      scene.environment = env;

      // Lights
      const key = new THREE.DirectionalLight(0x9bdcff, 1.1);
      key.position.set(6, 8, 6);
      scene.add(key);

      const fill = new THREE.DirectionalLight(0xc9a86a, 0.55);
      fill.position.set(-6, -2, 4);
      scene.add(fill);

      const hemi = new THREE.HemisphereLight(0x9bdcff, 0x05060a, 0.35);
      scene.add(hemi);

      group = new THREE.Group();
      scene.add(group);

      const glassMat = new THREE.MeshPhysicalMaterial({
        color: new THREE.Color(0.95, 0.98, 1.0),
        metalness: 0.08,
        roughness: 0.12,
        transmission: 1.0,
        thickness: 1.2,
        ior: 1.52,
        clearcoat: 1.0,
        clearcoatRoughness: 0.08,
        specularIntensity: 1.0,
        envMapIntensity: 1.2
      });

      const geo = [
        new THREE.IcosahedronGeometry(1.15, 0),
        new THREE.TorusKnotGeometry(0.72, 0.22, 140, 18),
        new THREE.OctahedronGeometry(1.0, 0),
        new THREE.DodecahedronGeometry(1.1, 0)
      ];

      const count = 12;
      for (let i = 0; i < count; i++){
        const g = geo[i % geo.length];
        const m = glassMat.clone();
        // slight tint variation
        const t = i / count;
        m.color = new THREE.Color().setHSL(0.56 + 0.08 * Math.sin(t * Math.PI * 2), 0.35, 0.92);
        m.roughness = 0.10 + 0.10 * Math.random();
        m.thickness = 0.8 + 1.4 * Math.random();

        const mesh = new THREE.Mesh(g, m);
        mesh.position.set(
          (Math.random() - 0.5) * 14,
          (Math.random() - 0.5) * 8,
          (Math.random() - 0.5) * 8
        );
        mesh.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
        mesh.userData = {
          base: mesh.position.clone(),
          spin: new THREE.Vector3((Math.random() - 0.5) * 0.25, (Math.random() - 0.5) * 0.25, (Math.random() - 0.5) * 0.25),
          phase: Math.random() * Math.PI * 2,
          amp: 0.35 + Math.random() * 0.55
        };
        group.add(mesh);
      }

      clock = new THREE.Clock();

      window.addEventListener('pointermove', (ev) => {
        const nx = (ev.clientX / window.innerWidth) * 2 - 1;
        const ny = (ev.clientY / window.innerHeight) * 2 - 1;
        mouse.tx = nx;
        mouse.ty = ny;
      }, { passive: true });

      window.addEventListener('resize', onResize, { passive: true });

      animate();
    }

    function onResize(){
      if (!renderer || !camera) return;
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    }

    function animate(){
      const dt = clock.getDelta();
      const t = clock.elapsedTime;

      // viscous parallax (lerp, not twitch)
      mouse.x += (mouse.tx - mouse.x) * (1 - Math.pow(0.001, dt));
      mouse.y += (mouse.ty - mouse.y) * (1 - Math.pow(0.001, dt));

      camera.position.x = mouse.x * 0.9;
      camera.position.y = -mouse.y * 0.6;
      camera.lookAt(0, 0, 0);

      // float & slow spin
      group.children.forEach((m, i) => {
        const ud = m.userData;
        const wobble = Math.sin(t * 0.65 + ud.phase) * ud.amp;
        m.position.x = ud.base.x + Math.sin(t * 0.35 + i) * 0.25;
        m.position.y = ud.base.y + wobble * 0.18;
        m.position.z = ud.base.z + Math.cos(t * 0.28 + i) * 0.22;

        m.rotation.x += ud.spin.x * dt;
        m.rotation.y += ud.spin.y * dt;
        m.rotation.z += ud.spin.z * dt;
      });

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    // -------------------------
    // Boot
    // -------------------------
    function boot(){
      state = sanitizeState(state);
      renderAll();
      intro();
      initThree();
      setStatus('Ready.');

      // Optional: preload Sisyphus stage image
      el.sisyImg.src = state.assets?.sisyphusDataUrl || DEFAULT_SISYPHUS_DATA_URL;
    }

    boot();
  </script>
</body>
</html>
