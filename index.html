<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intervention Dashboard — Escalation Cockpit</title>

  <!-- Tailwind (CDN, zero build) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind theme extension -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            obsidian: "#0B0F14",
            night: "#07111E",
            anthracite: "#10161F",
            smoke: "#A8B3C7",
            platinum: "#C7D0DE",
            rose: "#B7866B",      // Roségold
            carmine: "#B0122D",   // Karmesin
            legal: "#D11E3A",
            glass: "rgba(255,255,255,0.06)"
          },
          boxShadow: {
            luxe: "0 18px 60px rgba(0,0,0,0.55)",
            halo: "0 0 0 1px rgba(255,255,255,0.08), 0 18px 60px rgba(0,0,0,0.55)"
          }
        }
      }
    }
  </script>

  <!-- Alpine.js (reactive DOM state) -->
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>

  <!-- GSAP (micro-interactions, cinematic transitions) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <!-- ========== SINGLE SOURCE OF TRUTH (EDIT ONLY THIS JSON) ========== -->
  <script>
    window.ESCALATIONS = [
      {
        "Severity_Index": 10,
        "Client_Name": "Client A",
        "Context_Briefing": "Anwaltsschreiben angedroht. IBAN: DE44500105175407324931. Tel: +49 171 2345678. Bitte sofortige Rückmeldung.",
        "Action_Required": "Legal Risk triage: Sachverhalt prüfen, Rückruf, schriftliche Bestätigung vorbereiten.",
        "Deep_Link": "https://example.com/case/123",
        "Timestamp": "2026-01-22T08:12:00Z"
      },
      {
        "Severity_Index": 7,
        "Client_Name": "Client B",
        "Context_Briefing": "Logistikfehler: Paket hängt. Tracking: 1Z999AA10123456784. Kunde eskaliert.",
        "Action_Required": "Ops: Carrier kontaktieren, ETA verifizieren, proaktive Kundeninfo senden.",
        "Deep_Link": "https://example.com/ticket/456",
        "Timestamp": "2026-01-21T18:40:00Z"
      },
      {
        "Severity_Index": 3,
        "Client_Name": "Client C",
        "Context_Briefing": "Status-Update angefragt, keine Dringlichkeit. Tel: 030 1234567.",
        "Action_Required": "Kurz antworten: Status, nächste Schritte, Erwartungsmanagement.",
        "Deep_Link": "https://example.com/crm/789",
        "Timestamp": "2026-01-20T09:05:00Z"
      }
    ];
  </script>

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body {
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(183,134,107,0.18), transparent 55%),
        radial-gradient(900px 500px at 85% 25%, rgba(199,208,222,0.10), transparent 60%),
        radial-gradient(1100px 800px at 50% 120%, rgba(176,18,45,0.12), transparent 55%),
        linear-gradient(180deg, #07111E 0%, #0B0F14 60%, #070A0F 100%);
    }
    .glass {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .hairline {
      background: linear-gradient(90deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02), rgba(255,255,255,0.12));
      height: 1px;
    }
    .chip {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      transition: transform 180ms ease, box-shadow 180ms ease, background 180ms ease, border-color 180ms ease;
      will-change: transform;
    }
    .btn:hover { box-shadow: 0 14px 38px rgba(0,0,0,0.45); border-color: rgba(255,255,255,0.22); background: rgba(255,255,255,0.08); }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .card {
      transition: transform 220ms ease, box-shadow 220ms ease, border-color 220ms ease;
      will-change: transform;
    }
    .card:hover {
      transform: translateY(-2px) scale(1.008);
      box-shadow: 0 22px 70px rgba(0,0,0,0.62);
      border-color: rgba(255,255,255,0.18);
    }
    .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .no-select { user-select: none; }
    .toast {
      background: rgba(9, 14, 20, 0.72);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
    }
    .reduce-motion * { transition: none !important; animation: none !important; }
  </style>
</head>

<body class="text-platinum">
  <div
    x-data="dashboard()"
    x-init="init()"
    :class="reducedMotion ? 'reduce-motion' : ''"
    class="min-h-screen"
  >
    <!-- Header -->
    <header class="px-5 md:px-8 pt-7 pb-4">
      <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <div class="text-xs uppercase tracking-[0.28em] text-smoke/80 no-select">High-Fidelity Intervention Dashboard</div>
            <h1 class="mt-2 text-2xl md:text-3xl font-semibold tracking-tight">
              Escalation Cockpit
              <span class="text-smoke/70 font-normal">— form follows function, but the function wears a Patek suit.</span>
            </h1>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
            <div class="glass rounded-xl px-4 py-3">
              <div class="flex items-center gap-3 text-sm">
                <div class="flex items-center gap-2">
                  <span class="inline-block w-2 h-2 rounded-full" style="background:#D11E3A"></span>
                  <span class="text-smoke/85">Critical</span>
                  <span class="mono text-platinum" x-text="counts.t1"></span>
                </div>
                <div class="w-px h-4 bg-white/10"></div>
                <div class="flex items-center gap-2">
                  <span class="inline-block w-2 h-2 rounded-full" style="background:#B7866B"></span>
                  <span class="text-smoke/85">Ops</span>
                  <span class="mono text-platinum" x-text="counts.t2"></span>
                </div>
                <div class="w-px h-4 bg-white/10"></div>
                <div class="flex items-center gap-2">
                  <span class="inline-block w-2 h-2 rounded-full" style="background:#C7D0DE"></span>
                  <span class="text-smoke/85">Standard</span>
                  <span class="mono text-platinum" x-text="counts.t3"></span>
                </div>
              </div>
            </div>

            <div class="glass rounded-xl px-4 py-3 flex items-center gap-3">
              <input
                x-model="query"
                type="text"
                placeholder="Search (Name / Context / Action)…"
                class="bg-transparent outline-none text-sm w-56 md:w-72 placeholder:text-smoke/60"
              />
              <button class="btn magnetic rounded-lg px-3 py-2 text-xs text-smoke/85 hover:text-platinum"
                      @click="query=''; toast('Search cleared.')">
                Clear
              </button>
            </div>

            <button class="btn magnetic rounded-xl px-4 py-3 text-sm"
                    @click="showDismissed = !showDismissed">
              <span class="text-smoke/80">Dismissed</span>
              <span class="mono ml-2" x-text="counts.dismissed"></span>
              <span class="ml-2 text-smoke/70" x-text="showDismissed ? '▾' : '▸'"></span>
            </button>
          </div>
        </div>

        <div class="mt-5 hairline opacity-60"></div>
      </div>
    </header>

    <!-- Sticky Critical Tier -->
    <section class="px-5 md:px-8">
      <div class="max-w-6xl mx-auto">
        <div class="sticky top-3 z-40">
          <template x-if="tier1Filtered.length">
            <div class="glass rounded-2xl p-4 md:p-5 border border-white/10">
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <div class="w-2.5 h-2.5 rounded-full bg-legal"></div>
                  <div class="text-sm uppercase tracking-[0.22em] text-smoke/80">Tier 1 — Legal/Financial Risk</div>
                </div>
                <button class="btn magnetic rounded-xl px-4 py-2 text-xs"
                        @click="scrollToSection('tier2')">
                  Jump to Ops ↓
                </button>
              </div>

              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <template x-for="t in tier1Filtered" :key="t.id">
                  <div
                    class="glass card rounded-2xl p-4 md:p-5 relative overflow-hidden border border-white/10"
                    data-card
                    :data-id="t.id"
                  >
                    <div class="absolute inset-0 pointer-events-none opacity-60"
                         :style="`background: radial-gradient(500px 120px at 25% 0%, rgba(209,30,58,0.22), transparent 55%),
                                           radial-gradient(500px 160px at 80% 10%, rgba(183,134,107,0.14), transparent 60%)`">
                    </div>

                    <div class="relative flex items-start justify-between gap-3">
                      <div class="min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="text-xs uppercase tracking-[0.22em] text-smoke/80">CRITICAL</span>
                          <span class="mono text-xs px-2 py-1 rounded-lg border border-white/15 bg-white/5">
                            SVI <span x-text="t.Severity_Index"></span>/10
                          </span>
                        </div>
                        <div class="mt-2 text-lg font-semibold truncate" x-text="t.Client_Name"></div>
                        <div class="mt-1 text-sm text-smoke/85 line-clamp-2" x-text="t.Action_Required"></div>
                      </div>

                      <div class="flex flex-col items-end gap-2 shrink-0">
                        <div class="text-xs text-smoke/70 mono" x-text="formatRelative(t.Timestamp)"></div>
                        <a class="btn magnetic rounded-xl px-4 py-2 text-xs font-medium"
                           :class="t.Deep_Link ? 'text-platinum' : 'text-smoke/50 pointer-events-none opacity-60'"
                           :href="t.Deep_Link || '#'"
                           target="_blank" rel="noopener">
                          Open Case File →
                        </a>
                      </div>
                    </div>

                    <div class="mt-4 flex items-center justify-between gap-3 relative">
                      <button class="btn magnetic rounded-xl px-4 py-2 text-xs"
                              @click="toggleExpand(t.id, $event)">
                        <span x-text="expanded[t.id] ? 'Collapse' : 'Expand'"></span>
                      </button>

                      <button class="btn magnetic rounded-xl px-4 py-2 text-xs border-legal/50"
                              @click="dismissTicket(t, $event)">
                        Dismiss (not delete)
                      </button>
                    </div>

                    <div class="relative mt-4 overflow-hidden" data-details style="height:0; opacity:0">
                      <div class="hairline opacity-50 mb-4"></div>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">Context</div>
                          <div class="mt-2 text-sm text-smoke/90 leading-relaxed" x-text="t.Context_Briefing"></div>
                        </div>
                        <div>
                          <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">One‑Tap Extraction</div>
                          <div class="mt-2 flex flex-wrap gap-2">
                            <template x-for="token in extractTokens(t)" :key="token.value + token.type">
                              <button class="chip rounded-xl px-3 py-2 text-xs flex items-center gap-2 btn magnetic"
                                      @click="copy(token.value)">
                                <span class="text-smoke/70" x-text="token.type"></span>
                                <span class="mono text-platinum" x-text="token.value"></span>
                                <span class="text-smoke/60">⧉</span>
                              </button>
                            </template>
                            <template x-if="extractTokens(t).length === 0">
                              <div class="text-xs text-smoke/60">No extractable tokens detected.</div>
                            </template>
                          </div>

                          <div class="mt-4 text-xs text-smoke/60 mono">
                            Timestamp: <span x-text="formatExact(t.Timestamp)"></span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Pulsing halo hook -->
                    <div class="absolute -inset-8 pointer-events-none opacity-0" data-critical-halo></div>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <template x-if="!tier1Filtered.length">
            <div class="glass rounded-2xl p-4 md:p-5 border border-white/10">
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <div class="w-2.5 h-2.5 rounded-full bg-platinum/70"></div>
                  <div class="text-sm uppercase tracking-[0.22em] text-smoke/80">Tier 1 — clear</div>
                </div>
                <div class="text-xs text-smoke/60">No critical items above the fold. Enjoy it while it lasts.</div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <!-- Main tiers -->
    <main class="px-5 md:px-8 pt-6 pb-16">
      <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Tier 2 -->
        <section id="tier2" class="lg:col-span-7">
          <div class="glass rounded-2xl p-5">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">Tier 2</div>
                <div class="mt-1 text-lg font-semibold">Operational Failure</div>
              </div>
              <div class="text-xs text-smoke/60 mono" x-text="'Showing ' + tier2Filtered.length"></div>
            </div>

            <div class="mt-4 hairline opacity-60"></div>

            <div class="mt-5 grid grid-cols-1 gap-4">
              <template x-for="t in tier2Filtered" :key="t.id">
                <div class="glass card rounded-2xl p-4 md:p-5 border border-white/10 relative overflow-hidden"
                     data-card :data-id="t.id">
                  <div class="absolute inset-0 pointer-events-none opacity-50"
                       :style="`background: radial-gradient(520px 140px at 10% 0%, rgba(183,134,107,0.22), transparent 58%),
                                       radial-gradient(520px 180px at 90% 20%, rgba(199,208,222,0.10), transparent 60%)`"></div>

                  <div class="relative flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="mono text-xs px-2 py-1 rounded-lg border border-white/15 bg-white/5">
                          SVI <span x-text="t.Severity_Index"></span>/10
                        </span>
                        <span class="text-xs uppercase tracking-[0.22em] text-smoke/80">OPS</span>
                      </div>
                      <div class="mt-2 text-base font-semibold truncate" x-text="t.Client_Name"></div>
                      <div class="mt-1 text-sm text-smoke/85 line-clamp-2" x-text="t.Action_Required"></div>
                    </div>

                    <div class="flex flex-col items-end gap-2 shrink-0">
                      <div class="text-xs text-smoke/70 mono" x-text="formatRelative(t.Timestamp)"></div>
                      <a class="btn magnetic rounded-xl px-4 py-2 text-xs font-medium"
                         :class="t.Deep_Link ? 'text-platinum' : 'text-smoke/50 pointer-events-none opacity-60'"
                         :href="t.Deep_Link || '#'"
                         target="_blank" rel="noopener">
                        Open Case File →
                      </a>
                    </div>
                  </div>

                  <div class="mt-4 flex items-center justify-between gap-3 relative">
                    <button class="btn magnetic rounded-xl px-4 py-2 text-xs"
                            @click="toggleExpand(t.id, $event)">
                      <span x-text="expanded[t.id] ? 'Collapse' : 'Expand'"></span>
                    </button>

                    <button class="btn magnetic rounded-xl px-4 py-2 text-xs"
                            @click="dismissTicket(t, $event)">
                      Dismiss
                    </button>
                  </div>

                  <div class="relative mt-4 overflow-hidden" data-details style="height:0; opacity:0">
                    <div class="hairline opacity-50 mb-4"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">Context</div>
                        <div class="mt-2 text-sm text-smoke/90 leading-relaxed" x-text="t.Context_Briefing"></div>
                      </div>
                      <div>
                        <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">One‑Tap Extraction</div>
                        <div class="mt-2 flex flex-wrap gap-2">
                          <template x-for="token in extractTokens(t)" :key="token.value + token.type">
                            <button class="chip rounded-xl px-3 py-2 text-xs flex items-center gap-2 btn magnetic"
                                    @click="copy(token.value)">
                              <span class="text-smoke/70" x-text="token.type"></span>
                              <span class="mono text-platinum" x-text="token.value"></span>
                              <span class="text-smoke/60">⧉</span>
                            </button>
                          </template>
                          <template x-if="extractTokens(t).length === 0">
                            <div class="text-xs text-smoke/60">No extractable tokens detected.</div>
                          </template>
                        </div>

                        <div class="mt-4 text-xs text-smoke/60 mono">
                          Timestamp: <span x-text="formatExact(t.Timestamp)"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <template x-if="tier2Filtered.length === 0">
                <div class="text-sm text-smoke/70">No Tier‑2 items (under current search filter).</div>
              </template>
            </div>
          </div>
        </section>

        <!-- Tier 3 + Dismissed -->
        <aside class="lg:col-span-5 space-y-6">
          <section class="glass rounded-2xl p-5">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">Tier 3</div>
                <div class="mt-1 text-lg font-semibold">Standard Inbound</div>
              </div>
              <div class="text-xs text-smoke/60 mono" x-text="'Showing ' + tier3Filtered.length"></div>
            </div>

            <div class="mt-4 hairline opacity-60"></div>

            <div class="mt-5 grid grid-cols-1 gap-4">
              <template x-for="t in tier3Filtered" :key="t.id">
                <div class="glass card rounded-2xl p-4 border border-white/10 relative overflow-hidden"
                     data-card :data-id="t.id">
                  <div class="absolute inset-0 pointer-events-none opacity-45"
                       :style="`background: radial-gradient(520px 160px at 15% 0%, rgba(199,208,222,0.12), transparent 60%)`"></div>

                  <div class="relative flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="mono text-xs px-2 py-1 rounded-lg border border-white/15 bg-white/5">
                          SVI <span x-text="t.Severity_Index"></span>/10
                        </span>
                        <span class="text-xs uppercase tracking-[0.22em] text-smoke/80">STD</span>
                      </div>
                      <div class="mt-2 text-sm font-semibold truncate" x-text="t.Client_Name"></div>
                      <div class="mt-1 text-xs text-smoke/85 line-clamp-2" x-text="t.Action_Required"></div>
                    </div>

                    <div class="flex flex-col items-end gap-2 shrink-0">
                      <div class="text-xs text-smoke/70 mono" x-text="formatRelative(t.Timestamp)"></div>
                      <a class="btn magnetic rounded-xl px-3 py-2 text-xs font-medium"
                         :class="t.Deep_Link ? 'text-platinum' : 'text-smoke/50 pointer-events-none opacity-60'"
                         :href="t.Deep_Link || '#'"
                         target="_blank" rel="noopener">
                        Open →
                      </a>
                    </div>
                  </div>

                  <div class="mt-3 flex items-center justify-between gap-3 relative">
                    <button class="btn magnetic rounded-xl px-3 py-2 text-xs"
                            @click="toggleExpand(t.id, $event)">
                      <span x-text="expanded[t.id] ? 'Collapse' : 'Expand'"></span>
                    </button>

                    <button class="btn magnetic rounded-xl px-3 py-2 text-xs"
                            @click="dismissTicket(t, $event)">
                      Dismiss
                    </button>
                  </div>

                  <div class="relative mt-3 overflow-hidden" data-details style="height:0; opacity:0">
                    <div class="hairline opacity-50 mb-3"></div>
                    <div class="text-xs text-smoke/90 leading-relaxed" x-text="t.Context_Briefing"></div>

                    <div class="mt-3 flex flex-wrap gap-2">
                      <template x-for="token in extractTokens(t)" :key="token.value + token.type">
                        <button class="chip rounded-xl px-3 py-2 text-xs flex items-center gap-2 btn magnetic"
                                @click="copy(token.value)">
                          <span class="text-smoke/70" x-text="token.type"></span>
                          <span class="mono text-platinum" x-text="token.value"></span>
                          <span class="text-smoke/60">⧉</span>
                        </button>
                      </template>
                      <template x-if="extractTokens(t).length === 0">
                        <div class="text-xs text-smoke/60">No tokens.</div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>

              <template x-if="tier3Filtered.length === 0">
                <div class="text-sm text-smoke/70">No Tier‑3 items (under current search filter).</div>
              </template>
            </div>
          </section>

          <section class="glass rounded-2xl p-5" x-show="showDismissed" x-transition.opacity.duration.200ms>
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-[0.22em] text-smoke/80">Dismissed</div>
                <div class="mt-1 text-lg font-semibold">Archive (recoverable)</div>
              </div>
              <button class="btn magnetic rounded-xl px-4 py-2 text-xs"
                      @click="restoreAll()">
                Restore all
              </button>
            </div>

            <div class="mt-4 hairline opacity-60"></div>

            <div class="mt-5 grid grid-cols-1 gap-3">
              <template x-for="t in dismissedFiltered" :key="t.id">
                <div class="glass rounded-2xl p-4 border border-white/10 opacity-85">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="text-xs text-smoke/70 mono">SVI <span x-text="t.Severity_Index"></span>/10</div>
                      <div class="mt-1 text-sm font-semibold truncate" x-text="t.Client_Name"></div>
                      <div class="mt-1 text-xs text-smoke/80 line-clamp-2" x-text="t.Action_Required"></div>
                    </div>
                    <button class="btn magnetic rounded-xl px-3 py-2 text-xs"
                            @click="restoreTicket(t)">
                      Restore
                    </button>
                  </div>
                </div>
              </template>

              <template x-if="dismissedFiltered.length === 0">
                <div class="text-sm text-smoke/70">Nothing dismissed.</div>
              </template>
            </div>
          </section>
        </aside>
      </div>
    </main>

    <!-- Toast -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 pointer-events-none"
         x-show="toastState.show"
         x-transition.opacity.duration.160ms>
      <div class="toast rounded-2xl px-4 py-3 text-sm">
        <span class="text-smoke/85" x-text="toastState.msg"></span>
      </div>
    </div>

    <!-- Zero Inbox Reward Overlay -->
    <div class="fixed inset-0 z-[60] flex items-center justify-center px-6"
         x-show="reward.show"
         x-transition.opacity.duration.240ms
         style="display:none"
         aria-modal="true" role="dialog">
      <div class="absolute inset-0"
           style="background: radial-gradient(1200px 800px at 50% 35%, rgba(183,134,107,0.18), transparent 60%),
                          rgba(0,0,0,0.72); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px);">
      </div>

      <div class="relative glass rounded-3xl p-6 md:p-8 max-w-xl w-full border border-white/12 overflow-hidden">
        <div class="absolute -inset-20 pointer-events-none opacity-60"
             style="background: radial-gradient(700px 260px at 20% 10%, rgba(199,208,222,0.16), transparent 55%),
                            radial-gradient(700px 260px at 80% 20%, rgba(183,134,107,0.20), transparent 58%),
                            radial-gradient(900px 400px at 50% 120%, rgba(176,18,45,0.12), transparent 60%);">
        </div>

        <div class="relative">
          <div class="text-xs uppercase tracking-[0.28em] text-smoke/80">Zero Inbox</div>
          <div class="mt-2 text-2xl font-semibold">Mechanism Complete.</div>
          <div class="mt-2 text-sm text-smoke/85">
            Das Uhrwerk greift – weil Disziplin, nicht Chaos, hier den Takt vorgibt.
          </div>

          <div class="mt-6 flex items-center justify-center">
            <!-- Simple watchwork SVG (inline, no external assets) -->
            <svg id="watchwork" viewBox="0 0 420 220" class="w-full max-w-md">
              <defs>
                <radialGradient id="goldGlow" cx="50%" cy="40%" r="65%">
                  <stop offset="0%" stop-color="rgba(183,134,107,0.85)" />
                  <stop offset="55%" stop-color="rgba(183,134,107,0.20)" />
                  <stop offset="100%" stop-color="rgba(183,134,107,0.00)" />
                </radialGradient>
                <linearGradient id="steel" x1="0" x2="1">
                  <stop offset="0%" stop-color="rgba(199,208,222,0.18)" />
                  <stop offset="45%" stop-color="rgba(199,208,222,0.65)" />
                  <stop offset="100%" stop-color="rgba(199,208,222,0.18)" />
                </linearGradient>
              </defs>

              <rect x="0" y="0" width="420" height="220" fill="rgba(0,0,0,0)" />
              <circle cx="210" cy="110" r="96" fill="url(#goldGlow)" opacity="0.65"></circle>

              <!-- gears -->
              <g id="gearA" transform="translate(150 110)">
                <circle r="44" fill="none" stroke="url(#steel)" stroke-width="3"></circle>
                <circle r="18" fill="none" stroke="rgba(199,208,222,0.55)" stroke-width="2"></circle>
                <g stroke="rgba(199,208,222,0.55)" stroke-width="3">
                  <line x1="0" y1="-44" x2="0" y2="-56"></line>
                  <line x1="38" y1="-22" x2="48" y2="-28"></line>
                  <line x1="38" y1="22" x2="48" y2="28"></line>
                  <line x1="0" y1="44" x2="0" y2="56"></line>
                  <line x1="-38" y1="22" x2="-48" y2="28"></line>
                  <line x1="-38" y1="-22" x2="-48" y2="-28"></line>
                </g>
              </g>

              <g id="gearB" transform="translate(250 110)">
                <circle r="34" fill="none" stroke="url(#steel)" stroke-width="3"></circle>
                <circle r="14" fill="none" stroke="rgba(199,208,222,0.55)" stroke-width="2"></circle>
                <g stroke="rgba(183,134,107,0.65)" stroke-width="3">
                  <line x1="0" y1="-34" x2="0" y2="-45"></line>
                  <line x1="30" y1="-16" x2="40" y2="-22"></line>
                  <line x1="30" y1="16" x2="40" y2="22"></line>
                  <line x1="0" y1="34" x2="0" y2="45"></line>
                  <line x1="-30" y1="16" x2="-40" y2="22"></line>
                  <line x1="-30" y1="-16" x2="-40" y2="-22"></line>
                </g>
              </g>

              <!-- bridge -->
              <path id="bridge" d="M105 62 C170 20, 250 20, 315 62 L305 86 C250 56, 170 56, 115 86 Z"
                    fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.12)"></path>
            </svg>
          </div>

          <div class="mt-6 flex items-center justify-end gap-3">
            <button class="btn magnetic rounded-xl px-4 py-3 text-sm"
                    @click="closeReward()">
              Back to cockpit
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    function dashboard() {
      return {
        // state
        tickets: [],
        expanded: {},
        query: "",
        showDismissed: false,

        toastState: { show: false, msg: "" },
        reward: { show: false, fired: false },

        reducedMotion: false,

        init() {
          this.reducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

          this.tickets = (window.ESCALATIONS || []).map((t) => this.normalizeTicket(t));

          this.loadPersistedDismissals();
          this.recomputeExpandedKeys();

          this.$nextTick(() => {
            this.attachMagnetics();
            this.applyCriticalPulse();
            this.maybeZeroInbox();
          });

          window.addEventListener("resize", () => this.attachMagnetics());
        },

        // ---------- derived ----------
        get activeTickets() {
          return this.tickets.filter(t => !t.dismissed);
        },
        get dismissedTickets() {
          return this.tickets.filter(t => t.dismissed);
        },
        get counts() {
          const a = this.filtered(this.activeTickets);
          const d = this.filtered(this.dismissedTickets);
          return {
            t1: a.filter(t => this.tierOf(t.Severity_Index) === 1).length,
            t2: a.filter(t => this.tierOf(t.Severity_Index) === 2).length,
            t3: a.filter(t => this.tierOf(t.Severity_Index) === 3).length,
            dismissed: d.length
          };
        },
        get tier1Filtered() {
          return this.sorted(this.filtered(this.activeTickets).filter(t => this.tierOf(t.Severity_Index) === 1));
        },
        get tier2Filtered() {
          return this.sorted(this.filtered(this.activeTickets).filter(t => this.tierOf(t.Severity_Index) === 2));
        },
        get tier3Filtered() {
          return this.sorted(this.filtered(this.activeTickets).filter(t => this.tierOf(t.Severity_Index) === 3));
        },
        get dismissedFiltered() {
          return this.sorted(this.filtered(this.dismissedTickets));
        },

        // ---------- core transforms ----------
        normalizeTicket(t) {
          const safe = {
            Severity_Index: Number(t.Severity_Index ?? 1),
            Client_Name: String(t.Client_Name ?? "Unnamed"),
            Context_Briefing: String(t.Context_Briefing ?? ""),
            Action_Required: String(t.Action_Required ?? ""),
            Deep_Link: String(t.Deep_Link ?? ""),
            Timestamp: String(t.Timestamp ?? new Date().toISOString())
          };
          safe.Severity_Index = Math.max(1, Math.min(10, safe.Severity_Index));

          const idSeed = `${safe.Severity_Index}|${safe.Client_Name}|${safe.Action_Required}|${safe.Deep_Link}|${safe.Timestamp}`;
          return {
            ...safe,
            id: this.hash(idSeed),
            dismissed: false
          };
        },

        tierOf(sev) {
          if (sev >= 9) return 1;
          if (sev >= 6) return 2;
          return 3;
        },

        sorted(list) {
          return [...list].sort((a, b) => {
            if (b.Severity_Index !== a.Severity_Index) return b.Severity_Index - a.Severity_Index;
            return (new Date(b.Timestamp)).getTime() - (new Date(a.Timestamp)).getTime();
          });
        },

        filtered(list) {
          const q = (this.query || "").trim().toLowerCase();
          if (!q) return list;
          return list.filter(t => {
            const blob = `${t.Client_Name}\n${t.Context_Briefing}\n${t.Action_Required}\n${t.Deep_Link}`.toLowerCase();
            return blob.includes(q);
          });
        },

        recomputeExpandedKeys() {
          for (const t of this.tickets) {
            if (this.expanded[t.id] === undefined) this.expanded[t.id] = false;
          }
        },

        // ---------- UI actions ----------
        toggleExpand(id, evt) {
          this.expanded[id] = !this.expanded[id];
          const card = evt.currentTarget.closest("[data-card]");
          if (!card) return;
          const details = card.querySelector("[data-details]");
          if (!details) return;

          if (this.reducedMotion) {
            details.style.opacity = this.expanded[id] ? "1" : "0";
            details.style.height = this.expanded[id] ? "auto" : "0";
            return;
          }

          if (this.expanded[id]) {
            // open
            details.style.display = "block";
            gsap.killTweensOf(details);
            gsap.set(details, { height: 0, opacity: 0 });
            const targetH = details.scrollHeight;
            gsap.to(details, {
              height: targetH,
              opacity: 1,
              duration: 0.45,
              ease: "power3.out",
              onComplete: () => { details.style.height = "auto"; }
            });
          } else {
            // close
            gsap.killTweensOf(details);
            const currentH = details.scrollHeight;
            gsap.set(details, { height: currentH });
            gsap.to(details, {
              height: 0,
              opacity: 0,
              duration: 0.35,
              ease: "power2.inOut"
            });
          }
        },

        dismissTicket(t, evt) {
          const card = evt.currentTarget.closest("[data-card]");
          t.dismissed = true;
          this.persistDismissals();

          // collapse if expanded
          this.expanded[t.id] = false;

          if (this.reducedMotion || !card) {
            this.toast("Dismissed.");
            this.$nextTick(() => this.maybeZeroInbox());
            return;
          }

          // cinematic deconstruction: particle dispersion + lift/fade
          this.spawnParticles(card, this.tierOf(t.Severity_Index));

          gsap.to(card, {
            y: -18,
            opacity: 0,
            filter: "blur(2px)",
            duration: 0.55,
            ease: "power3.inOut",
            onComplete: () => {
              // keep it in DOM via Alpine, but visually reset for archive rendering
              gsap.set(card, { clearProps: "all" });
              this.toast("Dismissed (archived).");
              this.$nextTick(() => {
                this.applyCriticalPulse();
                this.maybeZeroInbox();
              });
            }
          });
        },

        restoreTicket(t) {
          t.dismissed = false;
          this.persistDismissals();
          this.toast("Restored.");
          this.$nextTick(() => {
            this.applyCriticalPulse();
          });
        },

        restoreAll() {
          for (const t of this.tickets) t.dismissed = false;
          this.persistDismissals();
          this.toast("All restored.");
          this.$nextTick(() => this.applyCriticalPulse());
        },

        scrollToSection(id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.scrollIntoView({ behavior: this.reducedMotion ? "auto" : "smooth", block: "start" });
        },

        // ---------- token extraction + copy ----------
        extractTokens(t) {
          const text = `${t.Context_Briefing}\n${t.Action_Required}`.toUpperCase();

          const tokens = [];
          const seen = new Set();

          // IBAN (simplified but practical)
          const ibanRegex = /\b[A-Z]{2}\d{2}[A-Z0-9]{11,30}\b/g;
          for (const m of (text.match(ibanRegex) || [])) {
            const v = m.replace(/\s+/g, "");
            if (!seen.has("IBAN:" + v)) {
              seen.add("IBAN:" + v);
              tokens.push({ type: "IBAN", value: v });
            }
          }

          // phone (broad EU-friendly heuristic)
          const phoneRegex = /(\+?\d[\d\s().-]{7,}\d)/g;
          for (const m of (t.Context_Briefing.match(phoneRegex) || [])) {
            const v = m.replace(/\s+/g, " ").trim();
            if (v.length >= 9 && v.length <= 22 && !seen.has("TEL:" + v)) {
              seen.add("TEL:" + v);
              tokens.push({ type: "TEL", value: v });
            }
          }

          // tracking (heuristic: long alnum with digits)
          const trackingRegex = /\b[A-Z0-9]{8,22}\b/g;
          for (const m of (text.match(trackingRegex) || [])) {
            // exclude IBAN-like
            if (/^[A-Z]{2}\d{2}/.test(m)) continue;
            // require digits to reduce false positives
            if (!/\d/.test(m)) continue;
            if (!seen.has("TRACK:" + m)) {
              seen.add("TRACK:" + m);
              tokens.push({ type: "TRACK", value: m });
            }
          }

          return tokens.slice(0, 10);
        },

        async copy(value) {
          const v = String(value || "");
          if (!v) return;

          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(v);
            } else {
              // fallback
              const ta = document.createElement("textarea");
              ta.value = v;
              ta.style.position = "fixed";
              ta.style.left = "-9999px";
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              document.execCommand("copy");
              document.body.removeChild(ta);
            }
            this.toast("Copied: " + v);
          } catch (e) {
            this.toast("Copy failed (browser permissions).");
          }
        },

        toast(msg) {
          this.toastState.msg = msg;
          this.toastState.show = true;
          clearTimeout(this._toastTimer);
          this._toastTimer = setTimeout(() => (this.toastState.show = false), 1600);
        },

        // ---------- persistence ----------
        persistDismissals() {
          const dismissedIds = this.tickets.filter(t => t.dismissed).map(t => t.id);
          localStorage.setItem("cockpit.dismissed", JSON.stringify(dismissedIds));
        },

        loadPersistedDismissals() {
          try {
            const raw = localStorage.getItem("cockpit.dismissed");
            if (!raw) return;
            const ids = new Set(JSON.parse(raw));
            for (const t of this.tickets) t.dismissed = ids.has(t.id);
          } catch (_) { /* ignore */ }
        },

        // ---------- aesthetics / motion ----------
        applyCriticalPulse() {
          if (this.reducedMotion) return;

          // kill existing
          gsap.killTweensOf("[data-critical-halo]");

          // apply only to current tier1 cards
          document.querySelectorAll("[data-card]").forEach(card => {
            const id = card.getAttribute("data-id");
            const t = this.tickets.find(x => x.id === id);
            if (!t) return;

            const halo = card.querySelector("[data-critical-halo]");
            if (!halo) return;

            if (!t.dismissed && this.tierOf(t.Severity_Index) === 1) {
              gsap.set(halo, {
                opacity: 0.55,
                background: "radial-gradient(420px 220px at 50% 30%, rgba(209,30,58,0.22), transparent 62%)"
              });
              gsap.to(halo, {
                opacity: 0.95,
                duration: 1.15,
                ease: "sine.inOut",
                yoyo: true,
                repeat: -1
              });
            } else {
              gsap.set(halo, { opacity: 0 });
            }
          });
        },

        spawnParticles(card, tier) {
          if (this.reducedMotion) return;

          const rect = card.getBoundingClientRect();
          const container = document.createElement("div");
          container.style.position = "fixed";
          container.style.left = rect.left + "px";
          container.style.top = rect.top + "px";
          container.style.width = rect.width + "px";
          container.style.height = rect.height + "px";
          container.style.pointerEvents = "none";
          container.style.zIndex = "80";
          document.body.appendChild(container);

          const color = tier === 1 ? "rgba(209,30,58,0.95)" : (tier === 2 ? "rgba(183,134,107,0.9)" : "rgba(199,208,222,0.85)");

          const n = 18;
          for (let i = 0; i < n; i++) {
            const p = document.createElement("div");
            const s = 6 + Math.random() * 10;
            p.style.position = "absolute";
            p.style.left = (rect.width * (0.35 + Math.random() * 0.30)) + "px";
            p.style.top = (rect.height * (0.25 + Math.random() * 0.50)) + "px";
            p.style.width = s + "px";
            p.style.height = s + "px";
            p.style.borderRadius = (Math.random() > 0.55 ? "999px" : "6px");
            p.style.background = `linear-gradient(180deg, ${color}, rgba(255,255,255,0.18))`;
            p.style.boxShadow = "0 14px 40px rgba(0,0,0,0.55)";
            p.style.opacity = "0.95";
            container.appendChild(p);

            gsap.to(p, {
              x: (Math.random() - 0.5) * rect.width * 0.9,
              y: -20 - Math.random() * 80,
              rotation: (Math.random() - 0.5) * 220,
              opacity: 0,
              scale: 0.6 + Math.random() * 0.4,
              duration: 0.65 + Math.random() * 0.25,
              ease: "power3.out"
            });
          }

          gsap.to(container, {
            opacity: 0,
            duration: 0.9,
            ease: "power2.out",
            onComplete: () => container.remove()
          });
        },

        attachMagnetics() {
          // magnetic buttons (subtle, expensive-feeling)
          if (this.reducedMotion) return;

          const els = document.querySelectorAll(".magnetic");
          els.forEach(el => {
            if (el._magnetAttached) return;
            el._magnetAttached = true;

            const strength = 10; // px
            const xTo = gsap.quickTo(el, "x", { duration: 0.35, ease: "power3.out" });
            const yTo = gsap.quickTo(el, "y", { duration: 0.35, ease: "power3.out" });

            const onMove = (e) => {
              const r = el.getBoundingClientRect();
              const cx = r.left + r.width / 2;
              const cy = r.top + r.height / 2;
              const dx = (e.clientX - cx) / (r.width / 2);
              const dy = (e.clientY - cy) / (r.height / 2);
              xTo(Math.max(-1, Math.min(1, dx)) * strength);
              yTo(Math.max(-1, Math.min(1, dy)) * strength);
            };

            const onLeave = () => { xTo(0); yTo(0); };

            el.addEventListener("mousemove", onMove);
            el.addEventListener("mouseleave", onLeave);
          });
        },

        maybeZeroInbox() {
          if (this.reward.fired) return;

          const activeCount = this.activeTickets.length;
          if (activeCount === 0) {
            this.reward.fired = true;
            this.openReward();
          }
        },

        openReward() {
          this.reward.show = true;
          this.$nextTick(() => this.animateWatchwork());
        },

        closeReward() {
          this.reward.show = false;
        },

        animateWatchwork() {
          if (this.reducedMotion) return;
          const a = document.getElementById("gearA");
          const b = document.getElementById("gearB");
          const bridge = document.getElementById("bridge");
          if (!a || !b || !bridge) return;

          gsap.set([a, b, bridge], { opacity: 0, y: 10, transformOrigin: "50% 50%" });

          const tl = gsap.timeline();
          tl.to([a, b, bridge], { opacity: 1, y: 0, duration: 0.55, ease: "power3.out", stagger: 0.08 })
            .to(a, { rotation: 360, duration: 3.2, ease: "none", repeat: -1 }, ">")
            .to(b, { rotation: -520, duration: 3.2, ease: "none", repeat: -1 }, "<");
        },

        // ---------- time formatting ----------
        formatExact(iso) {
          const d = new Date(iso);
          if (isNaN(d.getTime())) return iso;
          return d.toLocaleString(undefined, { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        },

        formatRelative(iso) {
          const d = new Date(iso);
          if (isNaN(d.getTime())) return iso;
          const diffMs = Date.now() - d.getTime();
          const m = Math.round(diffMs / 60000);
          if (m < 1) return "just now";
          if (m < 60) return `${m}m ago`;
          const h = Math.round(m / 60);
          if (h < 24) return `${h}h ago`;
          const days = Math.round(h / 24);
          return `${days}d ago`;
        },

        // ---------- util ----------
        hash(str) {
          // FNV-1a-ish (small, stable, good enough for local IDs)
          let h = 2166136261;
          for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
          }
          return ("id_" + (h >>> 0).toString(16));
        }
      };
    }
  </script>
</body>
</html>
