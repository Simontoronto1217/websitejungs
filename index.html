<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONEXT // SINGULARITY</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Rajdhani:wght@300;500;700&family=Space+Mono:wght@400&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CLOUD_CONFIG = {
            BIN_ID: '', // EINFÜGEN
            API_KEY: '' // EINFÜGEN
        };

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#020203',
                        'gold': '#E6C200',
                        'gold-dim': 'rgba(230, 194, 0, 0.1)',
                        'alert': '#FF2A2A',
                        'glass': 'rgba(255, 255, 255, 0.03)'
                    },
                    fontFamily: {
                        'display': ['Syncopate', 'sans-serif'],
                        'tech': ['Rajdhani', 'sans-serif'],
                        'mono': ['Space Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #020203; color: #fff; }
        
        /* LUXURY UI ELEMENTS */
        .hud-border {
            position: absolute; pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(to bottom, rgba(255,255,255,0.05) 0%, transparent 100%);
        }
        
        .ticket-card {
            background: linear-gradient(90deg, rgba(0,0,0,0.4) 0%, rgba(20,20,20,0.6) 100%);
            backdrop-filter: blur(4px);
            border-left: 2px solid rgba(255,255,255,0.1);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .ticket-card:hover {
            background: linear-gradient(90deg, rgba(230,194,0,0.05) 0%, rgba(0,0,0,0.8) 100%);
            border-left-color: #E6C200;
            transform: translateX(10px) scale(1.02);
            box-shadow: -20px 0 40px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* SCROLLBAR HIDDEN BUT FUNCTIONAL */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* INTRO OVERLAY */
        #intro-curtain {
            background: #000; z-index: 100;
        }
        
        /* GLITCH TEXT EFFECT */
        .glitch-hover:hover {
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
            color: #E6C200;
        }
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }

        .modal-blur { backdrop-filter: blur(20px); }
    </style>
</head>

<body x-data="singularity()" class="font-tech">

    <div id="webgl-container" class="fixed inset-0 z-0"></div>

    <div id="intro-curtain" class="fixed inset-0 flex items-center justify-center pointer-events-none">
        <div class="text-center">
            <h1 class="font-display text-4xl tracking-[0.5em] text-gold opacity-0 intro-text">SINGULARITY</h1>
            <div class="h-[1px] w-0 bg-white mx-auto mt-4 intro-line"></div>
        </div>
    </div>

    <main class="relative z-10 w-full h-screen flex p-8 gap-8 opacity-0 main-interface">
        
        <div class="w-2/3 h-full flex flex-col relative">
            <header class="flex justify-between items-end mb-8 border-b border-white/10 pb-4">
                <div>
                    <div class="flex items-center gap-2 text-gold/50 font-mono text-xs mb-1">
                        <div class="w-1.5 h-1.5 bg-gold rounded-full animate-pulse"></div>
                        <span x-text="connectionStatus"></span> // <span x-text="tickets.length + ' ACTIVE ENTITIES'"></span>
                    </div>
                    <h1 class="font-display text-3xl tracking-widest text-white">CHRONEXT<span class="text-gold">_OPS</span></h1>
                </div>
                <div class="flex gap-4">
                    <button @click="openModal()" class="px-6 py-2 border border-white/20 hover:border-gold hover:text-gold hover:bg-gold/5 transition-all font-mono text-xs tracking-widest uppercase glitch-hover">
                        [ + ] INJECT DATA
                    </button>
                    <button @click="syncData()" class="w-10 h-10 border border-white/20 flex items-center justify-center hover:bg-white/10 transition-all">
                         <svg class="w-4 h-4 text-white" :class="isLoading ? 'animate-spin text-gold' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path><path d="M21 12v9"></path></svg>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto no-scrollbar pr-4 space-y-3 relative perspective-container">
                <template x-for="(ticket, index) in sortedTickets" :key="ticket.id">
                    <div :id="'ticket-'+ticket.id" 
                         class="ticket-card p-5 relative group cursor-default"
                         @mouseenter="hoverTicket(ticket.severity)"
                         @mouseleave="resetEnvironment()">
                        
                        <div class="absolute left-0 top-0 bottom-0 w-[2px]" 
                             :class="ticket.severity >= 9 ? 'bg-alert shadow-[0_0_15px_#f00]' : (ticket.severity >= 6 ? 'bg-gold shadow-[0_0_10px_#fd0]' : 'bg-gray-500')"></div>

                        <div class="flex justify-between items-start">
                            <div class="w-3/4">
                                <div class="flex items-center gap-3 mb-1">
                                    <span class="font-display text-lg font-bold" :class="ticket.severity>=9 ? 'text-alert' : 'text-white'" x-text="ticket.severity"></span>
                                    <span class="font-mono text-xs text-gray-500" x-text="ticket.ref_id"></span>
                                    <span class="font-bold tracking-wide text-white" x-text="ticket.client"></span>
                                </div>
                                <p class="text-gray-400 text-sm font-light leading-relaxed font-sans opacity-80 group-hover:opacity-100 transition-opacity" x-text="ticket.context"></p>
                                
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <span class="text-[10px] font-mono border border-white/10 px-2 py-0.5 text-gray-400 uppercase" x-text="ticket.action"></span>
                                    <template x-if="ticket.wait_time_alert">
                                        <span class="text-[10px] font-mono border border-alert/30 text-alert px-2 py-0.5 uppercase animate-pulse" x-text="ticket.wait_time_alert"></span>
                                    </template>
                                    <template x-if="ticket.meta_copy">
                                        <button @click="copy(ticket.meta_copy)" class="text-[10px] font-mono bg-white/5 hover:bg-gold hover:text-black px-2 py-0.5 transition-colors uppercase">
                                            COPY DATA
                                        </button>
                                    </template>
                                </div>
                            </div>

                            <div class="flex flex-col gap-2 items-end opacity-20 group-hover:opacity-100 transition-all duration-300 transform translate-x-4 group-hover:translate-x-0">
                                <template x-if="ticket.link">
                                    <a :href="ticket.link" target="_blank" class="text-[10px] font-mono hover:text-gold tracking-widest border-b border-transparent hover:border-gold">OPEN LINK ↗</a>
                                </template>
                                <button @click="archive(ticket.id)" class="text-[10px] font-mono hover:text-alert tracking-widest border-b border-transparent hover:border-alert">RESOLVE_CASE</button>
                            </div>
                        </div>
                    </div>
                </template>

                <div x-show="tickets.length === 0" class="h-full flex flex-col items-center justify-center">
                    <h2 class="font-display text-2xl text-gold animate-pulse">SYSTEM STABLE</h2>
                    <p class="font-mono text-xs text-gray-600 mt-2">NO ANOMALIES DETECTED</p>
                </div>
            </div>
        </div>

        <div class="w-1/3 h-full flex flex-col justify-end pointer-events-none pb-8 pl-8 border-l border-white/5">
            <div class="glass-hud p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-50">
                    <svg class="w-8 h-8 text-gold animate-[spin_10s_linear_infinite]" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke-width="1" stroke-dasharray="4 4"></path></svg>
                </div>
                <h3 class="font-display text-xl text-white mb-2">GRAVITY WELL</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-[10px] font-mono text-gray-500 mb-1">
                            <span>STRESS_LEVEL</span>
                            <span x-text="calculateStress() + '%'"></span>
                        </div>
                        <div class="w-full h-1 bg-gray-800">
                            <div class="h-full bg-gradient-to-r from-gold to-alert transition-all duration-1000" :style="'width: ' + calculateStress() + '%'"></div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 font-light leading-relaxed">
                        <span class="text-gold font-mono">[SISYPHUS_PROTOCOL]</span>
                        <span x-show="tickets.length > 0">Active anomalies detected. Temporal distortions analyzed. Suggest immediate resolution of Priority 10 items.</span>
                        <span x-show="tickets.length === 0">Singularity achieved. Event horizon stable. Waiting for input stream.</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div x-show="showModal" 
         x-transition.opacity.duration.500ms
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 modal-blur">
        
        <div class="w-full max-w-5xl bg-black border border-white/10 shadow-[0_0_50px_rgba(230,194,0,0.1)] flex h-[70vh]">
            <div class="w-1/2 p-8 border-r border-white/10 flex flex-col">
                <h2 class="font-display text-xl text-gold mb-4">DATA STREAM INPUT</h2>
                <textarea x-model="rawData" class="flex-1 bg-[#050505] border border-white/10 p-4 text-xs font-mono text-gold focus:border-gold outline-none resize-none leading-relaxed" placeholder="PASTE EMAIL / SLACK / TICKET DATA HERE..."></textarea>
                <div class="flex gap-4 mt-4">
                    <button @click="showModal = false" class="px-6 py-3 font-mono text-xs border border-white/10 text-gray-500 hover:text-white">ABORT</button>
                    <button @click="processInput()" class="flex-1 px-6 py-3 bg-white/5 border border-gold text-gold font-display text-xs tracking-widest hover:bg-gold hover:text-black transition-all">
                        <span x-show="!isProcessing">ANALYZE</span>
                        <span x-show="isProcessing" class="animate-pulse">PROCESSING...</span>
                    </button>
                </div>
            </div>
            <div class="w-1/2 p-8 bg-[#080808] flex flex-col">
                <h2 class="font-display text-xl text-gray-500 mb-4 flex justify-between">
                    <span>DECODED</span>
                    <span x-text="detectedCases.length" class="text-white"></span>
                </h2>
                <div class="flex-1 overflow-y-auto no-scrollbar space-y-2">
                    <template x-for="(c, i) in detectedCases" :key="i">
                        <div class="p-3 border border-white/5 bg-white/5 relative group hover:border-gold/30 transition-colors">
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-gold" x-text="c.severity"></span>
                                <span class="text-[9px] font-mono text-gray-400" x-text="c.action"></span>
                            </div>
                            <input x-model="c.client" class="bg-transparent text-white font-bold text-sm w-full outline-none mb-1">
                            <div class="text-[10px] text-gray-500 truncate" x-text="c.context"></div>
                            <div x-show="c.wait_time_alert" class="text-[9px] text-alert mt-1 font-mono uppercase" x-text="c.wait_time_alert"></div>
                            <button @click="detectedCases.splice(i, 1)" class="absolute top-2 right-2 text-gray-600 hover:text-alert opacity-0 group-hover:opacity-100">✕</button>
                        </div>
                    </template>
                </div>
                <button x-show="detectedCases.length > 0" @click="confirmImport()" class="mt-4 w-full py-3 bg-gold text-black font-display font-bold hover:bg-white transition-colors">
                    COMMIT DATA
                </button>
            </div>
        </div>
    </div>

    <script>
        function singularity() {
            return {
                tickets: [],
                detectedCases: [],
                rawData: '',
                showModal: false,
                isProcessing: false,
                isLoading: false,
                connectionStatus: 'OFFLINE',
                
                // ThreeJS Refs
                scene: null, camera: null, renderer: null, particles: null, bloomComposer: null,
                
                async init() {
                    this.init3D();
                    this.introSequence();
                    
                    if(CLOUD_CONFIG.BIN_ID && CLOUD_CONFIG.API_KEY) {
                        this.connectionStatus = 'ONLINE';
                        await this.loadFromCloud();
                    } else {
                        const local = localStorage.getItem('chronext_v6');
                        if(local) this.tickets = JSON.parse(local);
                    }
                    this.updateEnvironment();
                },

                // --- 1. INTELLIGENCE PARSER (Enhanced) ---
                processInput() {
                    this.isProcessing = true;
                    this.detectedCases = [];
                    setTimeout(() => {
                        const text = this.rawData;
                        // Regex Logic
                        let chunks = text.replace(/\n\s*\n/g, '|||').split('|||');
                        if(chunks.length < 2 && text.length > 100) chunks = text.split(/(?=https:\/\/|Bitte|SR\d)/g);

                        chunks.forEach(chunk => {
                            if(chunk.length < 15) return;
                            let severity = 5, action = "REVIEW", waitAlert = null;

                            // Date Logic
                            const months = ['jan','feb','mär','apr','mai','jun','jul','aug','sep','okt','nov','dez'];
                            const mMatch = chunk.match(new RegExp(`(?:seit|vom|ab)\\s+(${months.join('|')})`, 'i'));
                            if(mMatch) {
                                let mIdx = months.findIndex(m => mMatch[1].toLowerCase().startsWith(m));
                                let diff = new Date().getMonth() - mIdx;
                                if(diff < 0) diff += 12;
                                if(diff >= 2) { severity += 3; waitAlert = `WAITING ${diff} MONTHS`; action = "DE-ESCALATE"; }
                            }

                            // Keywords
                            if(/anwalt|lawyer|polizei|frist/i.test(chunk)) { severity = 10; action = "LEGAL"; }
                            else if(/geld|iban|auszahlung/i.test(chunk)) { severity += 1; action = "FINANCE"; }
                            else if(/dhl|versand/i.test(chunk)) { severity += 1; action = "LOGISTICS"; }
                            else if(/rückruf/i.test(chunk) && action === "REVIEW") action = "CALLBACK";

                            // Extract
                            const link = (chunk.match(/https?:\/\/[^\s]+/) || [''])[0];
                            const ref = (chunk.match(/(SR\d+|PO\d+|#\d+)/i) || [''])[0].toUpperCase();
                            const meta = (chunk.match(/(\+49[\d\s]+|DE\d{20,})/) || [''])[0].replace(/\s/g,'');
                            let client = (chunk.match(/(?:Herr|Frau|Mr|Mrs)\.?\s+([A-ZÄÖÜ][a-zäöü]+(?:\s[A-ZÄÖÜ][a-zäöü]+)?)/) || [])[1] || ref || "Unknown";

                            this.detectedCases.push({
                                id: Date.now() + Math.random(),
                                client, ref_id: ref, context: chunk.replace(link,'').substring(0,120).trim() + "...",
                                severity: Math.min(severity, 10), action, link, meta_copy: meta, wait_time_alert: waitAlert
                            });
                        });
                        this.isProcessing = false;
                    }, 800);
                },

                async confirmImport() {
                    this.tickets.unshift(...this.detectedCases);
                    this.detectedCases = [];
                    this.showModal = false;
                    this.rawData = '';
                    await this.saveToCloud();
                    this.updateEnvironment();
                },

                // --- 2. DATA OPS ---
                async loadFromCloud() {
                    this.isLoading = true;
                    try {
                        const res = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.BIN_ID}/latest`, { headers: { 'X-Master-Key': CLOUD_CONFIG.API_KEY } });
                        const data = await res.json();
                        this.tickets = Array.isArray(data.record) ? data.record : [];
                    } catch(e) { console.error(e); }
                    this.isLoading = false;
                    this.updateEnvironment();
                },
                async saveToCloud() {
                    if(this.connectionStatus === 'OFFLINE') {
                        localStorage.setItem('chronext_v6', JSON.stringify(this.tickets));
                        return;
                    }
                    this.isLoading = true;
                    await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.BIN_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.API_KEY },
                        body: JSON.stringify(this.tickets)
                    });
                    this.isLoading = false;
                },
                archive(id) {
                    const el = document.getElementById('ticket-'+id);
                    gsap.to(el, { x: 100, opacity: 0, duration: 0.5, onComplete: async () => {
                        this.tickets = this.tickets.filter(t => t.id !== id);
                        await this.saveToCloud();
                        this.updateEnvironment();
                        this.warpEffect(); // Visual Reward
                    }});
                },
                copy(t) { navigator.clipboard.writeText(t); },
                openModal() { this.showModal = true; this.rawData = ''; this.detectedCases = []; },
                get sortedTickets() { return this.tickets.sort((a,b) => b.severity - a.severity); },
                calculateStress() { return Math.min(this.tickets.reduce((acc, t) => acc + t.severity, 0), 100); },

                // --- 3. VISUAL ENGINE (ThreeJS + Bloom) ---
                init3D() {
                    const container = document.getElementById('webgl-container');
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                    this.camera.position.z = 20;
                    
                    this.renderer = new THREE.WebGLRenderer({antialias: true});
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    container.appendChild(this.renderer.domElement);

                    // POST PROCESSING (BLOOM)
                    const renderScene = new THREE.RenderPass(this.scene, this.camera);
                    this.bloomComposer = new THREE.EffectComposer(this.renderer);
                    this.bloomComposer.addPass(renderScene);
                    
                    const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                    bloomPass.threshold = 0; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
                    this.bloomComposer.addPass(bloomPass);

                    // PARTICLES (The Event Horizon)
                    const pGeo = new THREE.BufferGeometry();
                    const pCount = 2000;
                    const posArray = new Float32Array(pCount * 3);
                    
                    for(let i=0; i<pCount * 3; i++) {
                        posArray[i] = (Math.random() - 0.5) * 60; 
                    }
                    
                    pGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                    const pMat = new THREE.PointsMaterial({ size: 0.1, color: 0xE6C200 });
                    this.particles = new THREE.Points(pGeo, pMat);
                    this.scene.add(this.particles);

                    // MOUSE INTERACTION
                    document.addEventListener('mousemove', (e) => {
                        const x = (e.clientX / window.innerWidth) * 2 - 1;
                        const y = -(e.clientY / window.innerHeight) * 2 + 1;
                        gsap.to(this.particles.rotation, { x: y * 0.2, y: x * 0.2, duration: 2 });
                    });

                    // ANIMATION LOOP
                    const animate = () => {
                        requestAnimationFrame(animate);
                        this.particles.rotation.z += 0.001; // Base rotation
                        this.bloomComposer.render();
                    };
                    animate();
                },

                updateEnvironment() {
                    // Changes visual state based on stress
                    const stress = this.calculateStress();
                    
                    if(stress > 50) {
                        // CHAOS MODE (Red, Fast)
                        gsap.to(this.particles.material.color, { r: 1, g: 0.2, b: 0.2, duration: 1 });
                        gsap.to(this.particles.rotation, { timeScale: 2, duration: 1 });
                    } else {
                        // GOLDEN ERA (Gold, Slow, Elegant)
                        gsap.to(this.particles.material.color, { r: 0.9, g: 0.76, b: 0, duration: 1 });
                    }
                },

                warpEffect() {
                    // Warp speed effect on resolve
                    gsap.to(this.particles.scale, { x: 2, y: 2, z: 2, duration: 0.2, yoyo: true, repeat: 1 });
                },

                hoverTicket(severity) {
                    // Camera reacts to high severity hover
                    if(severity >= 9) {
                        gsap.to(this.camera.position, { z: 18, duration: 0.5 }); // Zoom in slightly
                    }
                },
                resetEnvironment() {
                    gsap.to(this.camera.position, { z: 20, duration: 0.5 });
                },

                introSequence() {
                    const tl = gsap.timeline();
                    tl.to(".intro-text", { opacity: 1, duration: 1.5, ease: "power2.out" })
                      .to(".intro-line", { width: "200px", duration: 1 }, "-=0.5")
                      .to("#intro-curtain", { opacity: 0, display: "none", duration: 1.5, delay: 0.5 })
                      .to(".main-interface", { opacity: 1, duration: 1 });
                }
            }
        }
    </script>
</body>
</html>
